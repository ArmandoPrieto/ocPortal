<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2011

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		core_ocf
 */

/**
 * Module page class.
 */
class Module_myhome
{

	/**
	 * Standard modular info function.
	 *
	 * @return ?array	Map of module info (NULL: module is disabled).
	 */
	function info()
	{
		$info=array();
		$info['author']='Chris Graham';
		$info['organisation']='ocProducts';
		$info['hacked_by']=NULL;
		$info['hack_version']=NULL;
		$info['version']=2;
		$info['locked']=false;
		return $info;
	}
	
	/**
	 * Standard modular entry-point finder function.
	 *
	 * @return ?array	A map of entry points (type-code=>language-code) (NULL: disabled).
	 */
	function get_entry_points()
	{
		return array('!'=>'MY_HOME');
	}
	
	/**
	 * Standard modular run function.
	 *
	 * @return tempcode	The result of execution.
	 */
	function run()
	{
		if (get_forum_type()!='ocf') warn_exit(do_lang_tempcode('NO_OCF')); else ocf_require_all_forum_stuff();
		if (addon_installed('ocf_forum')) require_code('ocf_forumview');
		require_css('ocf');

		$member_id=get_param_integer('id',get_member());
		enforce_personal_access($member_id);
		$username=$GLOBALS['FORUM_DRIVER']->get_username($member_id);
		if (is_null($username)) warn_exit(do_lang_tempcode('USER_NO_EXIST'));

		$title=get_page_title('OCF_MEMBER_HOME',true,array(escape_html($username)));

		$galleries=new ocp_tempcode();
		if (addon_installed('galleries'))
		{
			// Show galleries
			require_lang('galleries');
			require_code('galleries');
			$rows=$GLOBALS['SITE_DB']->query('SELECT * FROM '.get_table_prefix().'galleries WHERE name LIKE \''.db_encode_like('member\_'.strval($member_id).'\_%').'\'');
			foreach ($rows as $i=>$row)
			{
				$galleries->attach(do_template('GALLERY_SUBGALLERY_WRAP',array('CONTENT'=>show_gallery_box($row,'root',false,get_module_zone('galleries')))));
			}
		}

		$topics=new ocp_tempcode();
		if (!has_no_forum())
		{
			// Last 15 topics that member contributed to
			$n=get_param_integer('max',15);
			$start=get_param_integer('start',0);
			$forum1=NULL;//$GLOBALS['FORUM_DRIVER']->forum_id_from_name(get_option('comments_forum_name'));
			$tf=get_option('ticket_forum_name',true);
			if (!is_null($tf)) $forum2=$GLOBALS['FORUM_DRIVER']->forum_id_from_name($tf); else $forum2=NULL;
			$where_more='';
			if (!is_null($forum1)) $where_more.=' AND p_cache_forum_id<>'.strval((integer)$forum1);
			if (!is_null($forum2)) $where_more.=' AND p_cache_forum_id<>'.strval((integer)$forum2);
			$rows=$GLOBALS['FORUM_DB']->query('SELECT DISTINCT p_topic_id FROM '.$GLOBALS['FORUM_DB']->get_table_prefix().'f_posts WHERE p_poster='.strval((integer)$member_id).$where_more.' ORDER BY p_time DESC',$n,$start);
			if (count($rows)!=0)
			{
				$max_rows=$GLOBALS['FORUM_DB']->query_value_null_ok_full('SELECT COUNT(DISTINCT p_topic_id) FROM '.$GLOBALS['FORUM_DB']->get_table_prefix().'f_posts WHERE p_poster='.strval((integer)$member_id).$where_more);

				$where='';
				foreach ($rows as $row)
				{
					if ($where!='') $where.=' OR ';
					$where.='t.id='.strval((integer)$row['p_topic_id']);
				}
				$topic_rows=$GLOBALS['FORUM_DB']->query('SELECT t.*,lan.text_parsed AS _trans_post,l_time FROM '.$GLOBALS['FORUM_DB']->get_table_prefix().'f_topics t LEFT JOIN '.$GLOBALS['FORUM_DB']->get_table_prefix().'f_read_logs l ON (t.id=l.l_topic_id AND l.l_member_id='.strval((integer)get_member()).') LEFT JOIN '.$GLOBALS['FORUM_DB']->get_table_prefix().'translate lan ON t.t_cache_first_post=lan.id WHERE '.$where);
				$topic_rows_map=array();
				foreach ($topic_rows as $topic_row)
				{
					$topic_rows_map[$topic_row['id']]=$topic_row;
				}
				$hot_topic_definition=intval(get_option('hot_topic_definition'));
				foreach ($rows as $row)
				{
					if (array_key_exists($row['p_topic_id'],$topic_rows_map))
						$topics->attach(ocf_render_topic(ocf_get_topic_array($topic_rows_map[$row['p_topic_id']],get_member(),$hot_topic_definition,true),false));
				}
				if (!$topics->is_empty())
				{
					$forum_name=do_lang_tempcode('TOPICS_PARTICIPATED_IN',integer_format($start+1).'-'.integer_format($start+$n));
					$marker='';
					$tree=new ocp_tempcode();
					require_code('templates_results_browser');
					$results_browser=results_browser(do_lang_tempcode('FORUM_TOPICS'),NULL,$start,'start',$n,'max',$max_rows,NULL,'misc',true);
					$topics=do_template('OCF_FORUM_TOPIC_WRAPPER',array('_GUID'=>'8723270b128b4eea47ab3c756b342e14','ORDER'=>'','MAX'=>'15','MAY_CHANGE_MAX'=>false,'TREE'=>$tree,'ACTION_URL'=>get_self_url(),'BUTTONS'=>'','STARTER_TITLE'=>'','MARKER'=>$marker,'FORUM_NAME'=>$forum_name,'TOPICS'=>$topics,'RESULTS_BROWSER'=>$results_browser,'MODERATOR_ACTIONS'=>''));
				}
			}
		}

		// Warnings
		$warnings=new ocp_tempcode();
		if (addon_installed('ocf_warnings'))
		{
			$rows=$GLOBALS['FORUM_DB']->query_select('f_warnings',array('*'),array('w_member_id'=>$member_id,'w_is_warning'=>1));
			foreach ($rows as $row)
			{
				$warning_by=$GLOBALS['FORUM_DRIVER']->member_profile_hyperlink($row['w_by']);
				$date=get_timezoned_date($row['w_time']);
				if ($row['w_explanation']=='') $row['w_explanation']='?'; else $row['w_explanation']=str_replace(chr(10),' ',$row['w_explanation']);
				$row['w_explanation_orig']=$row['w_explanation'];
				if (strlen($row['w_explanation'])>30) $row['w_explanation']=substr($row['w_explanation'],0,27).'...';
				$explanation=hyperlink(build_url(array('page'=>'warnings','type'=>'_ed','id'=>$row['id'],'redirect'=>get_self_url(true)),get_module_zone('warnings')),$row['w_explanation'],false,true,$row['w_explanation_orig']);
				$warnings->attach(paragraph(do_lang_tempcode('MEMBER_WARNING',$explanation,$warning_by,array(make_string_tempcode(escape_html($date)))),'treyerhy34y'));
			}
		}

		// Personal notes
		if (!is_null(post_param('notes',NULL)))
		{
			$notes=post_param('notes');
			$GLOBALS['FORUM_DB']->query_update('f_members',array('m_notes'=>$notes),array('id'=>$member_id),'',1);
		} else $notes=$GLOBALS['FORUM_DRIVER']->get_member_row_field($member_id,'m_notes');
		$notes_url=get_self_url();

		// Friends
		$friends_a=array();
		$friends_b=array();
		$all_buddies_link=new ocp_tempcode();
		if (addon_installed('chat'))
		{
			$rows=$GLOBALS['SITE_DB']->query('SELECT * FROM '.$GLOBALS['SITE_DB']->get_table_prefix().'chat_buddies WHERE member_likes='.strval(intval($member_id)).' OR member_liked='.strval(intval($member_id)).' ORDER BY date_and_time',100);
			//$rows=array(array('member_liked'=>2,'member_likes'=>3),array('member_liked'=>3,'member_likes'=>2));
			$blocked=collapse_1d_complexity('member_blocked',$GLOBALS['SITE_DB']->query_select('chat_blocking',array('member_blocked'),array('member_blocker'=>$member_id)));
			$done_already=array();
			$all_usergroups=$GLOBALS['FORUM_DRIVER']->get_usergroup_list(true);
			foreach ($rows as $i=>$row)
			{
				$f_id=($row['member_liked']==$member_id)?$row['member_likes']:$row['member_liked'];

				if (array_key_exists($f_id,$done_already)) continue;

				if (($f_id==$row['member_likes']) || (!in_array($f_id,$blocked)))
				{
					$appears_twice=false;
					foreach ($rows as $j=>$row2)
					{
						$f_id_2=($row2['member_liked']==$member_id)?$row2['member_likes']:$row2['member_liked'];
						if (($f_id_2==$f_id) && ($i!=$j))
						{
							$appears_twice=true;
							break;
						}
					}
					require_code('ocf_members2');
					$friend_username=$GLOBALS['FORUM_DRIVER']->get_username($f_id);
					$friend_usergroup_id=$GLOBALS['FORUM_DRIVER']->get_member_row_field($f_id,'m_primary_group');
					$friend_usergroup=array_key_exists($friend_usergroup_id,$all_usergroups)?$all_usergroups[$friend_usergroup_id]:do_lang_tempcode('UNKNOWN');
					$mutual_label=do_lang('MUTUAL_FRIEND');
					$box=ocf_show_member_box($f_id,false,NULL,NULL,true,(true)?array($mutual_label=>do_lang($appears_twice?'YES':'NO')):NULL);
					if ($box->is_empty()) continue;
					$friend_map=array('USERGROUP'=>$friend_usergroup,'USERNAME'=>$friend_username,'URL'=>$GLOBALS['FORUM_DRIVER']->member_profile_link($f_id,false,true),'F_ID'=>strval($f_id),'BOX'=>$box);
					if ($appears_twice) // Mutual friendship
					{
						$friends_a[]=$friend_map;
					} else // One-way friendship
					{
						$friends_b[]=$friend_map;
					}
				}

				$done_already[$f_id]=1;
			}
			if (count($rows)==100) $all_buddies_link=build_url(array('page'=>'chat','type'=>'buddies_list','id'=>$member_id),get_module_zone('chat'));
		}

		// Look up member's clubs
		$clubs=array();
		$club_ids=$GLOBALS['FORUM_DRIVER']->get_members_groups($member_id,true);
		$club_rows=list_to_map('id',$GLOBALS['FORUM_DB']->query_select('f_groups',array('*'),array('g_is_private_club'=>1),'',200));
		if (count($club_rows)==200) $club_rows=NULL;
		foreach ($club_ids as $club_id)
		{
			if (is_null($club_rows))
			{
				$club_rows=list_to_map('id',$GLOBALS['FORUM_DB']->query_select('f_groups',array('*'),array('g_is_private_club'=>1,'id'=>$club_id),'',200));
				if (!array_key_exists($club_id,$club_rows)) continue;
				$club_row=$club_rows[$club_id];
				$club_rows=NULL;
			} else
			{
				if (!array_key_exists($club_id,$club_rows)) continue;
				$club_row=$club_rows[$club_id];
			}

			$club_name=get_translated_text($club_row['g_name']);
			$club_forum=$GLOBALS['FORUM_DB']->query_value_null_ok('f_forums f LEFT JOIN '.$GLOBALS['FORUM_DB']->get_table_prefix().'translate t ON t.id=f.f_description','f.id',array('text_original'=>do_lang('FORUM_FOR_CLUB',$club_name)));

			$clubs[]=array(
				'CLUB_NAME'=>$club_name,
				'CLUB_ID'=>strval($club_row['id']),
				'CLUB_FORUM'=>is_null($club_forum)?'':strval($club_forum),
			);
		}

		return do_template('OCF_MEMBER_HOME_SCREEN',array('_GUID'=>'eeaec4ea0838fa78d94858c5768ea309','ALL_BUDDIES_LINK'=>$all_buddies_link,'CLUBS'=>$clubs,'FRIENDS_A'=>$friends_a,'FRIENDS_B'=>$friends_b,'MEMBER_ID'=>strval($member_id),'USERNAME'=>$username,'NOTES_URL'=>$notes_url,'NOTES'=>$notes,'TITLE'=>$title,'GALLERIES'=>$galleries,'WARNINGS'=>$warnings,'TOPICS'=>$topics));
	}

}


