<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2012

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

disable_php_memory_limit();
if (function_exists('set_time_limit')) @set_time_limit(0);
$GLOBALS['NO_DB_SCOPE_CHECK']=true;

require_code('tar');
require_code('files');
require_code('files2');

if ((get_option('htm_short_urls')!='1') || (get_option('mod_rewrite')!='1'))
	warn_exit('New-style short URLs must be enabled before te export can happen, as this is the tidy scheme we export to.');

if (get_option('site_closed')=='1')
	warn_exit('Site must not be closed.');

$filename='static-'.get_site_name().'.'.date('Y-m-d').'.tar';

@ob_end_clean();
@ob_end_clean();

header('Content-Type: application/octet-stream'.'; authoritative=true;');
if (strstr(ocp_srv('HTTP_USER_AGENT'),'MSIE')!==false)
	header('Content-Disposition: filename="'.str_replace(chr(13),'',str_replace(chr(10),'',addslashes($filename))).'"');
else
	header('Content-Disposition: attachment; filename="'.str_replace(chr(13),'',str_replace(chr(10),'',addslashes($filename))).'"');

global $STATIC_EXPORT_TAR;
$STATIC_EXPORT_TAR=tar_open(NULL,'wb');

$GLOBALS['NO_QUERY_LIMIT']=true;

// The content in the sitemap
require_code('sitemap');
require_code('static_export');
spawn_page_crawl('_pagelink_to_static',$GLOBALS['FORUM_DRIVER']->get_guest_id(),NULL,DEPTH__ENTRIES);

// Other media
$subpaths=array();
$subpaths=array_merge($subpaths,array('uploads'));
$subpaths=array_merge($subpaths,array('themes/default/templates_cached','themes/default/images','themes/default/images_custom'));
$theme=$GLOBALS['FORUM_DRIVER']->get_theme('');
if ($theme!='default')
	$subpaths=array_merge($subpaths,array('themes/'.$theme.'/templates_cached','themes/'.$theme.'/images','themes/'.$theme.'/images_custom'));
foreach ($subpaths as $subpath)
{
	if (substr($subpath,-strlen('/templates_cached'))=='/templates_cached')
	{
		foreach (get_directory_contents(get_custom_file_base().'/'.$subpath,'') as $file)
		{
			if ((substr($file,-4)=='.css') || (substr($file,-3)=='.js'))
				tar_add_file($STATIC_EXPORT_TAR,$subpath.'/'.$file,get_custom_file_base().'/'.$subpath.'/'.$file,0644,time(),true);
		}
	} else
	{
		tar_add_folder($STATIC_EXPORT_TAR,NULL,get_file_base(),NULL,$subpath,NULL,NULL,false,false);
	}
}

// .htaccess
$data='';
$data.='DirectoryIndex start.htm'.chr(10);
$data.=chr(10);
$data.=chr(10);
$data.='RewriteEngine on'.chr(10);
$data.=chr(10);
$data.=chr(10);
$directory=$STATIC_EXPORT_TAR['directory'];
foreach ($directory as $entry) // Rewrite non-specific pages to 'misc' files
{
	$dir_name=preg_replace('#^[A-Z][A-Z]/#','',dirname($entry['path']));
	if (($dir_name!='') && (basename($entry['path'])=='misc.htm'))
	{
		$data.='RewriteRule ^'.$dir_name.'\.htm(.*) '.$dir_name.'/misc.htm$1 [R,L]'.chr(10);
	}
}
$data.=chr(10);
$data.=chr(10);
$langs=find_all_langs();
if (count($langs)!=1) // Handling language detection
{
	// Recognise when language explicitly called
	foreach (array_keys($langs) as $lang)
	{
		if (($lang!=fallback_lang()) && (count(get_directory_contents(get_custom_file_base().'/lang_custom/'.$lang)<5))) continue; // Probably this is just the utf8 addon

		$data.='RewriteRule '.$lang.' - [L]'.chr(10); // This stops it looping; [L] ends an iteration for a directory level but doesn't stop inter-level recursions
		$data.='RewriteCond %{QUERY_STRING} keep_lang='.$lang.chr(10);
		$data.='RewriteRule (^.*\.htm.*$) '.$lang.'/$1 [L]'.chr(10);

		$data.=chr(10);
	}

	// Recognise when language supported by browser
	if (get_option('detect_lang_browser')=='1')
	{
		foreach (array_keys($langs) as $lang)
		{
			if (($lang!=fallback_lang()) && (count(get_directory_contents(get_custom_file_base().'/lang_custom/'.$lang)<5))) continue; // Probably this is just the utf8 addon
	
			$data.='RewriteCond %{HTTP:Accept-Language} ('.strtolower($lang).') [NC]'.chr(10);
			$data.='RewriteRule (^.*\.htm.*$) '.$lang.'/$1 [L]'.chr(10);
	
			$data.=chr(10);
		}
	}

	// And default to English
	$data.=chr(10);
	$data.='RewriteRule (^.*\.htm.*$) EN/$1 [L]'.chr(10);

	$data.=chr(10);
}
tar_add_file($STATIC_EXPORT_TAR,'.htaccess',$data,0644,time(),false);

tar_close($STATIC_EXPORT_TAR);

$GLOBALS['SCREEN_TEMPLATE_CALLED']='';
exit();
