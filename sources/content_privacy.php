<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2013

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		content_privacy
 */


function get_privacy_where_clause($content_type,$table_alias,$viewing_member_id=NULL)
{
	if (is_null($viewing_member_id)) $viewing_member_id=get_member();
	
	if ($GLOBALS['FORUM_DRIVER']->is_super_admin($viewing_member_id)) return array('','');
	
	require_code('content');
	$cma_ob=get_content_object($content_type);
	$cma_info=$cma_ob->info();
	
	if (!$cma_info['supports_privacy']) return array('','');
	
	$join=' LEFT JOIN '.get_table_prefix().'content_privacy p ON p.content_id='.$table_alias.'.'.$cma_info['id_field'].' AND '.db_string_equal_to('p.content_type',$content_type);
	$where=' AND (p.content_id IS NULL';
	$where.=' OR p.guest_view=1';
	if (!is_guest($viewing_member_id))
	{
		$where.=' OR p.member_view=1';
		$where.=' OR p.friend_view=1 AND EXISTS(SELECT * FROM '.get_table_prefix().'chat_friends f WHERE f.member_liked='.$table_alias.'.'.$cma_info['submitter_field'].' AND f.member_likes='.strval($viewing_member_id).')';
		$where.=' OR '.$table_alias.'.'.$cma_info['submitter_field'].'='.strval($viewing_member_id);
		$where.=' OR EXISTS(SELECT * FROM '.get_table_prefix().'content_primary__members pm WHERE member_id='.strval($viewing_member_id).' AND pm.content_id='.$table_alias.'.'.$cma_info['id_field'].' AND '.db_string_equal_to('pm.content_type',$content_type).')';
	}
	$where.=') ';
	return array($join,$where);
}


function check_privacy($content_type,$content_id)
{
	$viewing_member_id=get_member();
	
	require_code('content');
	$cma_ob=get_content_object($content_type);
	$cma_info=$cma_ob->info();
	
	list($privacy_join,$privacy_where)=get_privacy_where_clause($content_type,'e',$viewing_member_id);
	
	$results=$GLOBALS['SITE_DB']->query('SELECT * FROM '.get_table_prefix().$cma_info['table'].' e '.$privacy_join.' WHERE '.$privacy_where);
	
	if ($results==NULL) warn_exit(do_lang_tempcode('PRIVACY_BREACH'));
}

