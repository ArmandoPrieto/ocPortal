<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2013

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		content_privacy
 */


function get_privacy_form_fields($content_type,$content_id=NULL)
{
	if (is_guest()) return false;
	require_lang('ocf_privacy');
	require_code('form_templates');
	$fields=new ocp_tempcode();
	$privacy_options=new ocp_tempcode();
	
	if (!is_null($content_id))
	{
		$rows=$GLOBALS['SITE_DB']->query_select('content_privacy',NULL,array('content_type'=>strval($content_type),'content_id'=>$content_id));
		if (!count($rows))
		{
			$view_by_guests=true;
			$view_by_members=true;
			$view_by_friends=true;
		} else
		{
			$view_by_guests=($rows[0]['guest_view']==1);
			$view_by_members=($rows[0]['member_view']==1);
			$view_by_friends=($rows[0]['friend_view']==1);
		}
		$rows=$GLOBALS['SITE_DB']->query_select('content_primary__members',NULL,array('content_type'=>strval($content_type),'content_id'=>$content_id));
		if (!count($rows))
		{
			$additional_access=array();
		} else
		{
			foreach ($rows as $row)
			{
				$additional_access[]=$GLOBALS['FORUM_DRIVER']->get_username($row['member_id']);
			}
		}
	} else
	{
		$view_by_guests=true;
		$view_by_members=true;
		$view_by_friends=true;
		$additional_access=array();
	}
	
	$_fields=do_template('FORM_SCREEN_FIELD_SPACER',array('SECTION_HIDDEN'=>false,'TITLE'=>do_lang_tempcode('PRIVACY_SETTINGS')));
	
	$privacy_options->attach(form_input_list_entry('guests',$view_by_guests,do_lang_tempcode('VISIBLE_TO_GUESTS')));
	$privacy_options->attach(form_input_list_entry('members',$view_by_members && !$view_by_guests,do_lang_tempcode('VISIBLE_TO_MEMBERS')));
	$privacy_options->attach(form_input_list_entry('friends',$view_by_friends && !$view_by_members && !$view_by_guests,do_lang_tempcode('VISIBLE_TO_FRIENDS')));
	$privacy_options->attach(form_input_list_entry('staff',!$view_by_friends && !$view_by_members && !$view_by_guests,do_lang_tempcode('VISIBLE_TO_STAFF')));
	$fields->attach(form_input_list(do_lang_tempcode('VISIBLE_TO'),do_lang_tempcode('DESCRIPTION_VISIBLE_TO'),'privacy_level',$privacy_options));
	$fields->attach(form_input_username_multi(do_lang_tempcode('ADDITIONAL_ACCESS'),do_lang_tempcode('DESCRIPTION_ADDITIONAL_ACCESS'),'privacy_friends_list_',$additional_access,0));
	
	$_fields->attach($fields);
	$fields=$_fields;
	
	return $fields;
}


function save_privacy_form_fields($member_id,$content_type,$content_id,$privacy_level,$additional_access)
{
	if (is_guest()) return false;
	switch ($privacy_level)
	{
		case 'members':
			$member_view=1;
			$friend_view=0;
			$guest_view=0;
			break;
		
		case 'friends':
			$member_view=0;
			$friend_view=1;
			$guest_view=0;
			break;
			
		case 'staff':
			$member_view=0;
			$friend_view=0;
			$guest_view=0;
			break;
			
		case 'guests':
		default:
			$member_view=0;
			$friend_view=0;
			$guest_view=1;
			break;
	}
	$group_view='';
	$GLOBALS['SITE_DB']->query_insert('content_privacy',array(
		'member_id'=>$member_id,
		'content_type'=>$content_type,
		'content_id'=>$content_id,
		'guest_view'=>$guest_view,
		'member_view'=>$member_view,
		'friend_view'=>$friend_view,
		'group_view'=>$group_view,
	));
	if (count($additional_access))
	{
		$invited_members=array();
		foreach($additional_access as $member)
		{
			$member_id=$GLOBALS['FORUM_DRIVER']->get_member_from_username($member);
			if ($member_id!=NULL)
			{
				$GLOBALS['SITE_DB']->query_insert('content_primary__members',array(
					'member_id'=>$member_id,
					'content_type'=>$content_type,
					'content_id'=>$content_id,
				));
				$invited_members[]=$member_id;
			}
		}
		if (count($invited_members))
		{
			require_code('notifications');
			require_code('content');
			list($content_title,$content_submitter,$cma_info,,,$content_url)=content_get_details($content_type,$content_id);
			$content_submitter_username=$GLOBALS['FORUM_DRIVER']->get_username($content_submitter);
			$content_type_label=do_lang($cma_info['content_type_label']);

			$subject=do_lang('NOTIFICATION_SUBJECT_invited_content',comcode_escape($content_submitter_username));
			$mail=do_lang('NOTIFICATION_BODY_invited_content',comcode_escape($content_submitter_username),comcode_escape($content_type_label),array(comcode_escape($content_title),$content_url->evaluate()));
			dispatch_notification('invited_content',NULL,$subject,$mail,$invited_members);
		}
	}
	return true;
}


function update_privacy_form_fields($content_type,$content_id,$privacy_level,$additional_access)
{
	if (is_guest()) return false;
	switch ($privacy_level)
	{
		case 'members':
			$member_view=1;
			$friend_view=0;
			$guest_view=0;
			break;
		
		case 'friends':
			$member_view=0;
			$friend_view=1;
			$guest_view=0;
			break;
			
		case 'staff':
			$member_view=0;
			$friend_view=0;
			$guest_view=0;
			break;
			
		case 'guests':
		default:
			$member_view=0;
			$friend_view=0;
			$guest_view=1;
			break;
	}
	$group_view='';
	$GLOBALS['SITE_DB']->query_update('content_privacy',array('guest_view'=>$guest_view,'member_view'=>$member_view,'friend_view'=>$friend_view,'group_view'=>$group_view),array('content_type'=>$content_type,'content_id'=>$content_id));
	
	$rows=$GLOBALS['SITE_DB']->query_select('content_primary__members',array('member_id'),array('content_type'=>$content_type,'content_id'=>$content_id));
	if (count($rows))
	{
		foreach ($rows as $value)
		{
			$currently_invited_members[]=$value['member_id'];
		}
	} else
	{
		$currently_invited_members=array();
	}
	$GLOBALS['SITE_DB']->query_delete('content_primary__members',array('content_type'=>$content_type,'content_id'=>$content_id));
	if (count($additional_access))
	{
		$invited_members=array();
		foreach($additional_access as $member)
		{
			$member_id=$GLOBALS['FORUM_DRIVER']->get_member_from_username($member);
			if ($member_id!=NULL)
			{
				$GLOBALS['SITE_DB']->query_insert('content_primary__members',array(
					'member_id'=>$member_id,
					'content_type'=>$content_type,
					'content_id'=>$content_id,
				));
				if (!in_array($member_id,$currently_invited_members)) $invited_members[]=$member_id;
			}
		}
		if (count($invited_members))
		{
			require_code('notifications');
			require_code('content');
			list($content_title,$content_submitter,$cma_info,,,$content_url)=content_get_details($content_type,$content_id);
			$content_submitter_username=$GLOBALS['FORUM_DRIVER']->get_username($content_submitter);
			$content_type_label=do_lang($cma_info['content_type_label']);

			$subject=do_lang('NOTIFICATION_SUBJECT_invited_content',comcode_escape($content_submitter_username));
			$mail=do_lang('NOTIFICATION_BODY_invited_content',comcode_escape($content_submitter_username),comcode_escape($content_type_label),array(comcode_escape($content_title),$content_url->evaluate()));
			dispatch_notification('invited_content',NULL,$subject,$mail,$invited_members);
		}
	}
	return true;
}


function delete_privacy_form_fields($content_type,$content_id)
{
	if (is_guest()) return false;
	$GLOBALS['SITE_DB']->query_delete('content_privacy',array('content_type'=>$content_type,'content_id'=>$content_id));
	$GLOBALS['SITE_DB']->query_delete('content_primary__members',array('content_type'=>$content_type,'content_id'=>$content_id));
	return true;
}
