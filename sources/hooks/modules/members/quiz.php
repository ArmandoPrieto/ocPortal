<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2014

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		quizzes
 */

class Hook_members_quiz
{
	/**
	 * Standard modular run function.
	 *
	 * @param  MEMBER		The ID of the member we are getting link hooks for
	 * @return array		List of tuples for results. Each tuple is: type,title,url
	 */
	function run($member_id)
	{
		if (!addon_installed('quizzes')) return array();

		if (has_actual_page_access(get_member(),'admin_quiz',get_page_zone('admin_quiz')))
		{
			$modules[]=array('audit',do_lang_tempcode('QUIZ_RESULTS'),build_url(array('page'=>'admin_quiz','type'=>'_quiz_results','member_id'=>$member_id),get_module_zone('admin_quiz')),'menu/cms/quiz/quiz_results');
		}

		return $modules;
	}

	/**
	 * Standard modular get sections function.
	 *
	 * @param  MEMBER		The ID of the member we are getting sections for
	 * @return array		List of sections. Each tuple is Tempcode.
	 */
	function get_sections($member_id)
	{
		if (!addon_installed('quizzes')) return array();

		require_css('quizzes');
		require_lang('quiz');
		require_code('quiz');

		$entries=$GLOBALS['SITE_DB']->query_select('quiz_entries e JOIN '.get_table_prefix().'quizzes q ON q.id=e.q_quiz',array('e.id AS e_id','e.q_time','q.*'),array('q_member'=>$member_id,'q_type'=>'TEST','q_validated'=>1),'ORDER BY e.q_time ASC');
		$_entries=array();
		foreach ($entries as $entry)
		{
			list(
				,
				,
				$out_of,
				,
				,
				,
				,
				,
				$marks_range,
				$percentage_range,
				,
				,
				,
				,
				$passed,
			)=score_quiz($entry['e_id'],$entry['id'],$entry);

			$_entries[$entry['id']]=array(
				'QUIZ_NAME'=>get_translated_text($entry['q_name']),
				'QUIZ_START_TEXT'=>get_translated_tempcode($entry['q_start_text']),
				'QUIZ_ID'=>strval($entry['id']),
				'QUIZ_URL'=>build_url(array('page'=>'quiz','type'=>'do','id'=>$entry['id']),get_module_zone('quiz')),
				'ENTRY_ID'=>strval($entry['e_id']),
				'ENTRY_DATE'=>get_timezoned_date($entry['q_time'],false),
				'_ENTRY_DATE'=>strval($entry['q_time']),
				'OUT_OF'=>strval($out_of),
				'MARKS_RANGE'=>$marks_range,
				'PERCENTAGE_RANGE'=>$percentage_range,
				'PASSED'=>$passed,
			);
		}

		return array(do_template('MEMBER_QUIZ_ENTRIES',array('ENTRIES'=>$_entries,'MEMBER_ID'=>strval($member_id))));
	}
}


