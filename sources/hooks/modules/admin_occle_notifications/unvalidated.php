<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2011

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		occle
 */

class Hook_Notification_unvalidated
{
	/**
	* Standard modular run function for OcCLE notification hooks.
	*
	* @param  ?integer	The "current" time on which to base queries (NULL: now)
	* @return ~array 		Array of section, type and message responses (false: nothing)
	*/
	function run($timestamp=NULL)
	{
		if (!addon_installed('unvalidated')) return false;
		
		if (is_null($timestamp)) $timestamp=time();
		$hooks=find_all_hooks('modules','admin_unvalidated');
		if (count($hooks)<1) return false;

		require_lang('unvalidated');
		$modules=array();

		$too_much=false;

		foreach (array_keys($hooks) as $hook)
		{
			require_code('hooks/modules/admin_unvalidated/'.filter_naughty_harsh($hook));
			$object=object_factory('Hook_unvalidated_'.filter_naughty_harsh($hook),true);
			if (is_null($object)) continue;
			$info=$object->info();
			if (is_null($info)) continue;

			if (is_array($info['db_identifier']))
			{
				$db_identifier='';
				foreach ($info['db_identifier'] as $key=>$identifier)
				{
					$db_identifier.=(($key==0)?'':',').$identifier;
				}
			}
			else $db_identifier=$info['db_identifier'];

			$db=array_key_exists('db',$info)?$info['db']:$GLOBALS['SITE_DB'];
			$rows=$db->query('SELECT '.$db_identifier.(array_key_exists('db_title',$info)?(','.$info['db_title']):'').' FROM '.$db->get_table_prefix().$info['db_table'].' WHERE '.$info['db_validated'].'=0 AND ('.$info['db_add_date'].'>'.strval((integer)$timestamp).' OR '.$info['db_edit_date'].'>'.strval((integer)$timestamp).') ORDER BY '.$info['db_edit_date'].' DESC',20/*reasonable limit*/);
			if (count($rows)==20) $too_much=true;
			foreach ($rows as $row)
			{
				if (is_array($info['db_identifier']))
				{
					$id='';
					foreach ($info['db_identifier'] as $_id)
					{
						if ($id!='') $id.=':';
						$id.=$_id;
					}
				} else
				{
					$id=$row[$info['db_identifier']];
				}
				if (array_key_exists('db_title',$info))
				{
					$title=$row[$info['db_title']];
					if ($info['db_title_dereference']) $title=get_translated_text($title,$db); // May actually be comcode (can't be certain), but in which case it will be shown as source
				} else $title='#'.strval($id);
				if ($title=='') $title='#'.strval($id);

				$post_url=build_url(array('page'=>$info['edit_module'],'type'=>$info['edit_type'],$info['edit_identifier']=>$id),get_module_zone($info['edit_module']));

				$modules[$title]=$post_url;
			}
			/*if (count($rows)>0)
			{
				$modules[$info['title']]=build_url(array('page'=>$info['edit_module'],'type'=>$info['edit_type']),get_module_zone($info['edit_module']));
			}*/
		}
		if (count($modules)==0) return false;
		
		if ($too_much)
		{
			attach_message(do_lang_tempcode('TOO_MUCH_CHOOSE__RECENT_ONLY',escape_html(number_format(20))),'warn');
		}

		return array(do_lang('UNVALIDATED'),do_lang('UNVALIDATED_RESOURCES'),do_template('OCCLE_UNVALIDATED_NOTIFICATION',array('_GUID'=>'8652d2df11fa5faa9d3da74ace52c2d0','MODULES'=>$modules)));
	}

}

