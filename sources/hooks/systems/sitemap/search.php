SITEMAP_IMPORTANCE_MEDIUM
yearly

$kids=array();
if ($dont_care_about_categories)
{
	$rows=array();
} else
{
	$query='SELECT c.c_title,c.c_name,t.text_original FROM '.get_table_prefix().'catalogues c';
	if (can_arbitrary_groupby())
		$query.=' JOIN '.get_table_prefix().'catalogue_entries e ON e.c_name=c.c_name';
	$query.=' LEFT JOIN '.$GLOBALS['SITE_DB']->get_table_prefix().'translate t ON '.db_string_equal_to('language',user_lang()).' AND c.c_title=t.id';
	if (can_arbitrary_groupby())
		$query.=' GROUP BY c.c_name';
	$rows=$GLOBALS['SITE_DB']->query($query);
}
foreach ($rows as $row)
{
	if (is_null($row['text_original'])) $row['text_original']=get_translated_text($row['c_title']);

	$kids[]=array('_SELF:_SELF:type=misc:id=catalogue_entries:catalogue_name='.$row['c_name'],NULL,NULL,$row['text_original'],array());
}


$_hooks=find_all_hooks('modules','search');
foreach (array_keys($_hooks) as $hook)
{
	require_code('hooks/modules/search/'.filter_naughty_harsh($hook));
	$ob=object_factory('Hook_search_'.filter_naughty_harsh($hook),true);
	if (is_null($ob)) continue;
	$info=$ob->info();
	if (is_null($info)) continue;

	if (($hook=='catalogue_entries') || (array_key_exists('special_on',$info)) || (array_key_exists('special_off',$info)) || (method_exists($ob,'get_tree')) || (method_exists($ob,'ajax_tree')))
	{
		$kids=array();
		if (($hook=='catalogue_entries') && ($max_depth>1))
		{
			if ($dont_care_about_categories)
			{
				$rows=array();
			} else
			{
				$query='SELECT c.c_title,c.c_name,t.text_original FROM '.get_table_prefix().'catalogues c';
				if (can_arbitrary_groupby())
					$query.=' JOIN '.get_table_prefix().'catalogue_entries e ON e.c_name=c.c_name';
				$query.=' LEFT JOIN '.$GLOBALS['SITE_DB']->get_table_prefix().'translate t ON '.db_string_equal_to('language',user_lang()).' AND c.c_title=t.id';
				if (can_arbitrary_groupby())
					$query.=' GROUP BY c.c_name';
				$rows=$GLOBALS['SITE_DB']->query($query);
			}
			foreach ($rows as $row)
			{
				if (!has_category_access(get_member(),'catalogues_catalogue',$row['c_name'])) continue;

				if (is_null($row['text_original'])) $row['text_original']=get_translated_text($row['c_title']);

				$kids[]=array('_SELF:_SELF:type=misc:id='.$hook.':catalogue_name='.$row['c_name'],NULL,NULL,$row['text_original'],array());
			}
		}
		$tree[]=array('_SELF:_SELF:type=misc:id='.$hook,NULL,NULL,$info['lang'],$kids,'','',$hook=='catalogue_entries');
	}
}


<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2014

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		search
 */

class Hook_sitemap_search extends Hook_sitemap_base
{
	TODO
}
