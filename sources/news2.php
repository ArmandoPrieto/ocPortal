<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2013

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		news
 */

/*
RSS IMPORT (works very well with Wordpress and Blogger, which use RSS as an interchange)
*/

/**
 * Add a news category of the specified details.
 *
 * @param  SHORT_TEXT	The news category title
 * @param  ID_TEXT		The theme image ID of the picture to use for the news category
 * @param  LONG_TEXT		Notes for the news category
 * @param  ?MEMBER		The owner (NULL: public)
 * @param  ?AUTO_LINK	Force an ID (NULL: don't force an ID)
 * @return AUTO_LINK		The ID of our new news category
 */
function add_news_category($title,$img,$notes,$owner=NULL,$id=NULL)
{
	$map=array('nc_title'=>insert_lang($title,1),'nc_img'=>$img,'notes'=>$notes,'nc_owner'=>$owner);
	if (!is_null($id)) $map['id']=$id;
	$id=$GLOBALS['SITE_DB']->query_insert('news_categories',$map,true);

	log_it('ADD_NEWS_CATEGORY',strval($id),$title);

	if ((addon_installed('occle')) && (!running_script('install')))
	{
		require_code('resource_fs');
		generate_resourcefs_moniker('news_category',strval($id),NULL,NULL,true);
	}

	decache('side_news_categories');

	return $id;
}

/**
 * Edit a news category.
 *
 * @param  AUTO_LINK			The news category to edit
 * @param  ?SHORT_TEXT		The title (NULL: keep as-is)
 * @param  ?SHORT_TEXT		The image (NULL: keep as-is)
 * @param  ?LONG_TEXT		The notes (NULL: keep as-is)
 * @param  ?MEMBER			The owner (NULL: public)
*/
function edit_news_category($id,$title,$img,$notes,$owner)
{
	$myrows=$GLOBALS['SITE_DB']->query_select('news_categories',array('nc_title','nc_img','notes'),array('id'=>$id),'',1);
	if (!array_key_exists(0,$myrows)) warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
	$myrow=$myrows[0];

	$old_title=get_translated_text($myrow['nc_title']);

	require_code('urls2');
	suggest_new_idmoniker_for('news','misc',strval($id),'',$title);

	// Sync meta keywords, if we have auto-sync for these
	if (get_value('disable_seo')==='1') // TODO: Update to get_option in v10
	{
		$sql='SELECT meta_keywords,text_original FROM '.get_table_prefix().'seo_meta m JOIN '.get_table_prefix().'translate t ON m.meta_keywords=t.id AND '.db_string_equal_to('language',user_lang()).' WHERE '.db_string_equal_to('meta_for_type','news').' AND (text_original LIKE \''.db_encode_like($old_title.',%').'\' OR text_original LIKE \''.db_encode_like('%,'.$old_title.',%').'\' OR text_original LIKE \''.db_encode_like('%,'.$old_title).'\')';
		$affected_news=$GLOBALS['SITE_DB']->query($sql);
		foreach ($affected_news as $af_row)
		{
			$new_meta=str_replace(',,',',',preg_replace('#(^|,)'.preg_quote($old_title).'($|,)#',','.$title.',',$af_row['text_original']));
			if (substr($new_meta,0,1)==',') $new_meta=substr($new_meta,1);
			if (substr($new_meta,-1)==',') $new_meta=substr($new_meta,0,strlen($new_meta)-1);
			lang_remap($af_row['meta_keywords'],$new_meta);
		}
	}

	log_it('EDIT_NEWS_CATEGORY',strval($id),$title);

	if ((addon_installed('occle')) && (!running_script('install')))
	{
		require_code('resource_fs');
		generate_resourcefs_moniker('news_category',strval($id));
	}

	if (is_null($title)) $title=get_translated_text($myrow['nc_title']);
	if (is_null($img)) $img=$myrow['nc_img'];
	if (is_null($notes)) $notes=$myrow['notes'];

	$update_map=array('nc_title'=>lang_remap($myrow['nc_title'],$title),'nc_img'=>$img,'notes'=>$notes);
	$update_map['nc_owner']=$owner;

	$GLOBALS['SITE_DB']->query_update('news_categories',$update_map,array('id'=>$id),'',1);

	require_code('themes2');
	tidy_theme_img_code($img,$myrow['nc_img'],'news_categories','nc_img');

	decache('main_news');
	decache('side_news');
	decache('side_news_archive');
	decache('bottom_news');
	decache('side_news_categories');
}

/**
 * Delete a news category.
 *
 * @param  AUTO_LINK		The news category to delete
 */
function delete_news_category($id)
{
	$rows=$GLOBALS['SITE_DB']->query_select('news_categories',array('nc_title','nc_img'),array('id'=>$id),'',1);
	if (!array_key_exists(0,$rows)) warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
	$myrow=$rows[0];

	$min=$GLOBALS['SITE_DB']->query_value_if_there('SELECT MIN(id) FROM '.get_table_prefix().'news_categories WHERE id<>'.strval($id));
	if (is_null($min))
	{
		warn_exit(do_lang_tempcode('YOU_MUST_KEEP_ONE_NEWS_CAT'));
	}

	$old_title=get_translated_text($myrow['nc_title']);

	delete_lang($myrow['nc_title']);

	$GLOBALS['SITE_DB']->query_update('news',array('news_category'=>$min),array('news_category'=>$id));
	$GLOBALS['SITE_DB']->query_delete('news_categories',array('id'=>$id),'',1);
	$GLOBALS['SITE_DB']->query_delete('news_category_entries',array('news_entry_category'=>$id));

	$GLOBALS['SITE_DB']->query_delete('group_category_access',array('module_the_name'=>'news','category_name'=>strval($id)));
	$GLOBALS['SITE_DB']->query_delete('group_privileges',array('module_the_name'=>'news','category_name'=>strval($id)));

	require_code('themes2');
	tidy_theme_img_code(NULL,$myrow['nc_img'],'news_categories','nc_img');

	decache('side_news_categories');

	log_it('DELETE_NEWS_CATEGORY',strval($id),$old_title);

	// Sync meta keywords, if we have auto-sync for these
	if (get_value('disable_seo')==='1') // TODO: Update to get_option in v10
	{
		$sql='SELECT meta_keywords,text_original FROM '.get_table_prefix().'seo_meta m JOIN '.get_table_prefix().'translate t ON m.meta_keywords=t.id AND '.db_string_equal_to('language',user_lang()).' WHERE '.db_string_equal_to('meta_for_type','news').' AND (text_original LIKE \''.db_encode_like($old_title.',%').'\' OR text_original LIKE \''.db_encode_like('%,'.$old_title.',%').'\' OR text_original LIKE \''.db_encode_like('%,'.$old_title).'\')';
		$affected_news=$GLOBALS['SITE_DB']->query($sql);
		foreach ($affected_news as $af_row)
		{
			$new_meta=str_replace(',,',',',preg_replace('#(^|,)'.preg_quote($old_title).'($|,)#','',$af_row['text_original']));
			if (substr($new_meta,0,1)==',') $new_meta=substr($new_meta,1);
			if (substr($new_meta,-1)==',') $new_meta=substr($new_meta,0,strlen($new_meta)-1);
			lang_remap($af_row['meta_keywords'],$new_meta);
		}
	}


	if ((addon_installed('occle')) && (!running_script('install')))
	{
		require_code('resource_fs');
		expunge_resourcefs_moniker('news_category',strval($id));
	}
}

/**
 * Adds a news entry to the database, and send out the news to any RSS cloud listeners.
 *
 * @param  SHORT_TEXT		The news title
 * @param  LONG_TEXT			The news summary (or if not an article, the full news)
 * @param  ?ID_TEXT			The news author (possibly, a link to an existing author in the system, but does not need to be) (NULL: current username)
 * @param  BINARY				Whether the news has been validated
 * @param  BINARY				Whether the news may be rated
 * @param  SHORT_INTEGER	Whether comments are allowed (0=no, 1=yes, 2=review style)
 * @param  BINARY				Whether the news may have trackbacks
 * @param  LONG_TEXT			Notes for the news
 * @param  LONG_TEXT			The news entry (blank means no entry)
 * @param  ?AUTO_LINK		The primary news category (NULL: personal)
 * @param  ?array				The IDs of the news categories that this is in (NULL: none)
 * @param  ?TIME				The time of submission (NULL: now)
 * @param  ?MEMBER			The news submitter (NULL: current member)
 * @param  integer			The number of views the article has had
 * @param  ?TIME				The edit date (NULL: never)
 * @param  ?AUTO_LINK		Force an ID (NULL: don't force an ID)
 * @param  URLPATH			URL to the image for the news entry (blank: use cat image)
 * @param  ?SHORT_TEXT		Meta keywords for this resource (NULL: do not edit) (blank: implicit)
 * @param  ?LONG_TEXT		Meta description for this resource (NULL: do not edit) (blank: implicit)
 * @return AUTO_LINK			The ID of the news just added
 */
function add_news($title,$news,$author=NULL,$validated=1,$allow_rating=1,$allow_comments=1,$allow_trackbacks=1,$notes='',$news_article='',$main_news_category=NULL,$news_categories=NULL,$time=NULL,$submitter=NULL,$views=0,$edit_date=NULL,$id=NULL,$image='',$meta_keywords='',$meta_description='')
{
	if (is_null($author)) $author=$GLOBALS['FORUM_DRIVER']->get_username(get_member());
	if (is_null($news_categories)) $news_categories=array();
	if (is_null($time)) $time=time();
	if (is_null($submitter)) $submitter=get_member();
	$already_created_personal_category=false;

	require_code('comcode_check');
	check_comcode($news_article,NULL,false,NULL,true);

	if (is_null($main_news_category))
	{
		$main_news_category_id=$GLOBALS['SITE_DB']->query_select_value_if_there('news_categories','id',array('nc_owner'=>$submitter));
		if (is_null($main_news_category_id))
		{
			if (!has_privilege(get_member(),'have_personal_category','cms_news')) fatal_exit(do_lang_tempcode('INTERNAL_ERROR'));

			$p_nc_title=insert_lang(do_lang('MEMBER_CATEGORY',$GLOBALS['FORUM_DRIVER']->get_username($submitter)),2);

			$main_news_category_id=$GLOBALS['SITE_DB']->query_insert('news_categories',array('nc_title'=>$p_nc_title,'nc_img'=>'newscats/community','notes'=>'','nc_owner'=>$submitter),true);
			$already_created_personal_category=true;

			$groups=$GLOBALS['FORUM_DRIVER']->get_usergroup_list(false,true);

			foreach (array_keys($groups) as $group_id)
				$GLOBALS['SITE_DB']->query_insert('group_category_access',array('module_the_name'=>'news','category_name'=>strval($main_news_category_id),'group_id'=>$group_id));
		}
	} else
	{
		$main_news_category_id=$main_news_category;
	}

	if (!addon_installed('unvalidated')) $validated=1;
	$map=array('news_image'=>$image,'edit_date'=>$edit_date,'news_category'=>$main_news_category_id,'news_views'=>$views,'news_article'=>0,'allow_rating'=>$allow_rating,'allow_comments'=>$allow_comments,'allow_trackbacks'=>$allow_trackbacks,'notes'=>$notes,'submitter'=>$submitter,'validated'=>$validated,'date_and_time'=>$time,'title'=>insert_lang_comcode($title,1),'news'=>insert_lang_comcode($news,1),'author'=>$author);
	if (!is_null($id)) $map['id']=$id;
	$id=$GLOBALS['SITE_DB']->query_insert('news',$map,true);

	if (!is_null($news_categories))
	{
		foreach ($news_categories as $i=>$value)
		{
			if ((is_null($value)) && (!$already_created_personal_category))
			{
				$p_nc_title=insert_lang(do_lang('MEMBER_CATEGORY',$GLOBALS['FORUM_DRIVER']->get_username($submitter)),2);
				$news_category_id=$GLOBALS['SITE_DB']->query_insert('news_categories',array('nc_title'=>$p_nc_title,'nc_img'=>'newscats/community','notes'=>'','nc_owner'=>$submitter),true);

				$groups=$GLOBALS['FORUM_DRIVER']->get_usergroup_list(false,true);

				foreach (array_keys($groups) as $group_id)
					$GLOBALS['SITE_DB']->query_insert('group_category_access',array('module_the_name'=>'news','category_name'=>strval($news_category_id),'group_id'=>$group_id));
			}
			else $news_category_id=$value;

			if (is_null($news_category_id)) continue; // Double selected

			$GLOBALS['SITE_DB']->query_insert('news_category_entries',array('news_entry'=>$id,'news_entry_category'=>$news_category_id));

			$news_categories[$i]=$news_category_id;
		}
	}

	require_code('attachments2');
	$map=array('news_article'=>insert_lang_comcode_attachments(2,$news_article,'news',strval($id)));
	$GLOBALS['SITE_DB']->query_update('news',$map,array('id'=>$id),'',1);

	log_it('ADD_NEWS',strval($id),$title);

	if ((addon_installed('occle')) && (!running_script('install')))
	{
		require_code('resource_fs');
		generate_resourcefs_moniker('news',strval($id),NULL,NULL,true);
	}

	if (function_exists('xmlrpc_encode'))
	{
		if (function_exists('set_time_limit')) @set_time_limit(0);

		// Send out on RSS cloud
		if (!$GLOBALS['SITE_DB']->table_is_locked('news_rss_cloud'))
			$GLOBALS['SITE_DB']->query('DELETE FROM '.get_table_prefix().'news_rss_cloud WHERE register_time<'.strval(time()-25*60*60));
		$start=0;
		do
		{
			$listeners=$GLOBALS['SITE_DB']->query_select('news_rss_cloud',array('*'),NULL,'',100,$start);
			foreach ($listeners as $listener)
			{
				$data=$listener['watching_channel'];
				if ($listener['rem_protocol']=='xml-rpc')
				{
					$request=xmlrpc_encode_request($listener['rem_procedure'],$data);
					$length=strlen($request);
					$_length=strval($length);
$packet=<<<END
POST /{$listener['rem_path']} HTTP/1.0
Host: {$listener['rem_ip']}
Content-Type: text/xml
Content-length: {$_length}

{$request}
END;
				}
				$errno=0;
				$errstr='';
				$mysock=@fsockopen($listener['rem_ip'],$listener['rem_port'],$errno,$errstr,6.0);
				if ($mysock!==false)
				{
					@fwrite($mysock,$packet);
					@fclose($mysock);
				}
				$start+=100;
			}
		}
		while (array_key_exists(0,$listeners));
	}

	require_code('seo2');
	if (get_value('disable_seo')==='1') // TODO: Update to get_option in v10
	{
		$meta_keywords='';
		foreach (array_unique(array_merge(is_null($news_categories)?array():$news_categories,array($main_news_category_id))) as $news_category_id)
		{
			if ($meta_keywords!='') $meta_keywords.=',';
			$meta_keywords.=get_translated_text($GLOBALS['SITE_DB']->query_select_value('news_categories','nc_title',array('id'=>$news_category_id)));
		}
	}
	if (($meta_keywords=='') && ($meta_description==''))
	{
		$meta_description=($news=='')?$news_article:$news;
		seo_meta_set_for_implicit('news',strval($id),array($title,$meta_description/*,$news_article*/),$meta_description); // News article could be used, but it's probably better to go for the summary only to avoid crap
	} else
	{
		seo_meta_set_for_explicit('news',strval($id),$meta_keywords,$meta_description);
	}

	if ($validated==1)
	{
		decache('main_news');
		decache('side_news');
		decache('side_news_archive');
		decache('bottom_news');

		dispatch_news_notification($id,$title,$main_news_category_id);
	}

	if (($validated==1) && (get_option('site_closed')=='0') && (ocp_srv('HTTP_HOST')!='127.0.0.1') && (ocp_srv('HTTP_HOST')!='localhost') && (has_category_access($GLOBALS['FORUM_DRIVER']->get_guest_id(),'news',strval($main_news_category_id))))
	{
		$_ping_url=str_replace('{url}',urlencode(get_base_url()),str_replace('{rss}',urlencode(find_script('backend')),str_replace('{title}',urlencode(get_site_name()),get_option('ping_url'))));
		$ping_urls=explode(chr(10),$_ping_url);
		foreach ($ping_urls as $ping_url)
		{
			$ping_url=trim($ping_url);
			if ($ping_url!='') http_download_file($ping_url,NULL,false);
		}
	}

	return $id;
}

/**
 * Edit a news entry.
 *
 * @param  AUTO_LINK			The ID of the news to edit
 * @param  SHORT_TEXT		The news title
 * @param  LONG_TEXT			The news summary (or if not an article, the full news)
 * @param  ID_TEXT			The news author (possibly, a link to an existing author in the system, but does not need to be)
 * @param  BINARY				Whether the news has been validated
 * @param  BINARY				Whether the news may be rated
 * @param  SHORT_INTEGER	Whether comments are allowed (0=no, 1=yes, 2=review style)
 * @param  BINARY				Whether the news may have trackbacks
 * @param  LONG_TEXT			Notes for the news
 * @param  LONG_TEXT			The news entry (blank means no entry)
 * @param  AUTO_LINK			The primary news category (NULL: personal)
 * @param  ?array				The IDs of the news categories that this is in (NULL: do not change)
 * @param  SHORT_TEXT		Meta keywords
 * @param  LONG_TEXT			Meta description
 * @param  ?URLPATH			URL to the image for the news entry (blank: use cat image) (NULL: don't delete existing)
 * @param  ?TIME				Add time (NULL: do not change)
 * @param  ?TIME				Edit time (NULL: either means current time, or if $null_is_literal, means reset to to NULL)
 * @param  ?integer			Number of views (NULL: do not change)
 * @param  ?MEMBER			Submitter (NULL: do not change)
 * @param  boolean			Determines whether some NULLs passed mean 'use a default' or literally mean 'set to NULL'
 */
function edit_news($id,$title,$news,$author,$validated,$allow_rating,$allow_comments,$allow_trackbacks,$notes,$news_article,$main_news_category,$news_categories,$meta_keywords,$meta_description,$image,$add_time=NULL,$edit_time=NULL,$views=NULL,$submitter=NULL,$null_is_literal=false)
{
	if (is_null($edit_time)) $edit_time=$null_is_literal?NULL:time();

	$rows=$GLOBALS['SITE_DB']->query_select('news',array('title','news','news_article','submitter'),array('id'=>$id),'',1);
	$_title=$rows[0]['title'];
	$_news=$rows[0]['news'];
	$_news_article=$rows[0]['news_article'];

	require_code('urls2');

	suggest_new_idmoniker_for('news','view',strval($id),'',$title);

	require_code('attachments2');
	require_code('attachments3');

	if (!addon_installed('unvalidated')) $validated=1;

	require_code('submit');
	$just_validated=(!content_validated('news',strval($id))) && ($validated==1);
	if ($just_validated)
	{
		send_content_validated_notification('news',strval($id));
	}

	$update_map=array(
		'news_category'=>$main_news_category,
		'news_article'=>update_lang_comcode_attachments($_news_article,$news_article,'news',strval($id),NULL,false,$rows[0]['submitter']),
		'allow_rating'=>$allow_rating,
		'allow_comments'=>$allow_comments,
		'allow_trackbacks'=>$allow_trackbacks,
		'notes'=>$notes,
		'validated'=>$validated,
		'title'=>lang_remap_comcode($_title,$title),
		'news'=>lang_remap_comcode($_news,$news),
		'author'=>$author,
	);

	$update_map['edit_date']=$edit_time;
	if (!is_null($add_time))
		$update_map['date_and_time']=$add_time;
	if (!is_null($views))
		$update_map['news_views']=$views;
	if (!is_null($submitter))
		$update_map['submitter']=$submitter;

	if (!is_null($image))
	{
		$update_map['news_image']=$image;
		require_code('files2');
		delete_upload('uploads/grepimages','news','news_image','id',$id,$image);
	}

	if (!is_null($news_categories))
	{
		$GLOBALS['SITE_DB']->query_delete('news_category_entries',array('news_entry'=>$id));

		foreach ($news_categories as $value)
		{
			$GLOBALS['SITE_DB']->query_insert('news_category_entries',array('news_entry'=>$id,'news_entry_category'=>$value));
		}
	}

	log_it('EDIT_NEWS',strval($id),$title);

	if ((addon_installed('occle')) && (!running_script('install')))
	{
		require_code('resource_fs');
		generate_resourcefs_moniker('news',strval($id));
	}

	$GLOBALS['SITE_DB']->query_update('news',$update_map,array('id'=>$id),'',1);

	$self_url=build_url(array('page'=>'news','type'=>'view','id'=>$id),get_module_zone('news'),NULL,false,false,true);

	if ($just_validated)
	{
		dispatch_news_notification($id,$title,$main_news_category);
	}

	require_code('seo2');
	if (get_value('disable_seo')==='1') // TODO: Update to get_option in v10
	{
		$meta_description=($news=='')?$news_article:$news;
		$meta_keywords='';
		foreach (array_unique(array_merge(is_null($news_categories)?array():$news_categories,array($main_news_category))) as $news_category_id)
		{
			if ($meta_keywords!='') $meta_keywords.=',';
			$meta_keywords.=get_translated_text($GLOBALS['SITE_DB']->query_select_value('news_categories','nc_title',array('id'=>$news_category_id)));
		}
	}
	seo_meta_set_for_explicit('news',strval($id),$meta_keywords,$meta_description);

	decache('main_news');
	decache('side_news');
	decache('side_news_archive');
	decache('bottom_news');

	if (($validated==1) && (has_category_access($GLOBALS['FORUM_DRIVER']->get_guest_id(),'news',strval($main_news_category))))
	{
		$_ping_url=str_replace('{url}',urlencode(get_base_url()),str_replace('{rss}',urlencode(find_script('backend')),str_replace('{title}',urlencode(get_site_name()),get_option('ping_url'))));
		$ping_urls=explode(',',$_ping_url);
		foreach ($ping_urls as $ping_url)
		{
			$ping_url=trim($ping_url);
			if ($ping_url!='') http_download_file($ping_url,NULL,false);
		}
	}

	require_code('feedback');
	update_spacer_post($allow_comments!=0,'news',strval($id),$self_url,$title,get_value('comment_forum__news'));
}

/**
 * Send out a notification of some new news.
 *
 * @param  AUTO_LINK		The ID of the news
 * @param  SHORT_TEXT	The title
 * @param  AUTO_LINK		The main news category
 */
function dispatch_news_notification($id,$title,$main_news_category)
{
	$self_url=build_url(array('page'=>'news','type'=>'view','id'=>$id),get_module_zone('news'),NULL,false,false,true);

	$is_blog=!is_null($GLOBALS['SITE_DB']->query_select_value('news_categories','nc_owner',array('id'=>$main_news_category)));

	if (addon_installed('content_privacy'))
	{
		require_code('content_privacy');
		$privacy_limits=privacy_limits_for('news',strval($id));
	} else
	{
		$privacy_limits=array();
	}

	require_code('notifications');
	require_lang('news');
	if ($is_blog)
	{
		$subject=do_lang('BLOG_NOTIFICATION_MAIL_SUBJECT',get_site_name(),$title);
		$mail=do_lang('BLOG_NOTIFICATION_MAIL',comcode_escape(get_site_name()),comcode_escape($title),array($self_url->evaluate()));
		dispatch_notification('news_entry',strval($main_news_category),$subject,$mail,$privacy_limits);
	} else
	{
		$subject=do_lang('NEWS_NOTIFICATION_MAIL_SUBJECT',get_site_name(),$title);
		$mail=do_lang('NEWS_NOTIFICATION_MAIL',comcode_escape(get_site_name()),comcode_escape($title),array($self_url->evaluate()));
		dispatch_notification('news_entry',strval($main_news_category),$subject,$mail,$privacy_limits);
	}
}

/**
 * Delete a news entry.
 *
 * @param  AUTO_LINK		The ID of the news to edit
 */
function delete_news($id)
{
	$rows=$GLOBALS['SITE_DB']->query_select('news',array('title','news','news_article'),array('id'=>$id),'',1);
	$title=$rows[0]['title'];
	$news=$rows[0]['news'];
	$news_article=$rows[0]['news_article'];

	$_title=get_translated_text($title);

	require_code('files2');
	delete_upload('uploads/grepimages','news','news_image','id',$id);

	$GLOBALS['SITE_DB']->query_delete('news',array('id'=>$id),'',1);
	$GLOBALS['SITE_DB']->query_delete('news_category_entries',array('news_entry'=>$id));

	$GLOBALS['SITE_DB']->query_delete('rating',array('rating_for_type'=>'news','rating_for_id'=>$id));
	$GLOBALS['SITE_DB']->query_delete('trackbacks',array('trackback_for_type'=>'news','trackback_for_id'=>$id));

	delete_lang($title);
	delete_lang($news);
	require_code('attachments2');
	require_code('attachments3');
	if (!is_null($news_article)) delete_lang_comcode_attachments($news_article,'news',strval($id));

	require_code('seo2');
	seo_meta_erase_storage('news',strval($id));

	decache('main_news');
	decache('side_news');
	decache('side_news_archive');
	decache('bottom_news');

	log_it('DELETE_NEWS',strval($id),$_title);

	if ((addon_installed('occle')) && (!running_script('install')))
	{
		require_code('resource_fs');
		expunge_resourcefs_moniker('news',strval($id));
	}
}

/**
 * Import wordpress db
 * Get UI fields for starting news import.
 *
 * @param  boolean	Whether to import to blogs, by default
 * @return tempcode	UI fields
 */
function import_rss_fields($import_to_blog)
{
	$fields=new ocp_tempcode();

	$set_name='rss';
	$required=true;
	$set_title=do_lang_tempcode('FILE');
	$field_set=alternate_fields_set__start($set_name);

	$field_set->attach(form_input_upload(do_lang_tempcode('UPLOAD'),'','file_novalidate',false,NULL,NULL,true,'rss,xml,atom'));
	$field_set->attach(form_input_line(do_lang_tempcode('URL'),'','rss_feed_url','',false));

	$fields->attach(alternate_fields_set__end($set_name,$set_title,do_lang_tempcode('DESCRIPTION_WP_XML'),$field_set,$required));

	$fields->attach(do_template('FORM_SCREEN_FIELD_SPACER',array('SECTION_HIDDEN'=>false,'TITLE'=>do_lang_tempcode('ADVANCED'))));

	$fields->attach(form_input_tick(do_lang_tempcode('IMPORT_BLOG_COMMENTS'),do_lang_tempcode('DESCRIPTION_IMPORT_BLOG_COMMENTS'),'import_blog_comments',true));
	if (addon_installed('unvalidated'))
		$fields->attach(form_input_tick(do_lang_tempcode('AUTO_VALIDATE_ALL_POSTS'),do_lang_tempcode('DESCRIPTION_VALIDATE_ALL_POSTS'),'auto_validate',true));
	if ($GLOBALS['FORUM_DRIVER']->is_super_admin(get_member()))
		$fields->attach(form_input_tick(do_lang_tempcode('ADD_TO_OWN_ACCOUNT'),do_lang_tempcode('DESCRIPTION_ADD_TO_OWN_ACCOUNT'),'add_to_own',false));
	if (has_privilege(get_member(),'draw_to_server'))
		$fields->attach(form_input_tick(do_lang_tempcode('DOWNLOAD_IMAGES'),do_lang_tempcode('DESCRIPTION_DOWNLOAD_IMAGES'),'download_images',true));
	if ($GLOBALS['FORUM_DRIVER']->is_super_admin(get_member()))
		$fields->attach(form_input_tick(do_lang_tempcode('IMPORT_TO_BLOG'),do_lang_tempcode('DESCRIPTION_IMPORT_TO_BLOG'),'import_to_blog',true));

	return $fields;
}

/**
 * Import RSS
 */
function import_rss()
{
	require_code('rss');
	require_code('files');

	$GLOBALS['LAX_COMCODE']=true;

	disable_php_memory_limit();
	if (function_exists('set_time_limit')) @set_time_limit(0);

	$is_validated=post_param_integer('auto_validate',0);
	if (!addon_installed('unvalidated')) $is_validated=1;
	$download_images=post_param_integer('download_images',0);
	if (!has_privilege(get_member(),'draw_to_server')) $download_images=0;
	$to_own_account=post_param_integer('add_to_own',0);
	if (!$GLOBALS['FORUM_DRIVER']->is_super_admin(get_member())) $to_own_account=0;
	$import_blog_comments=post_param_integer('import_blog_comments',0);
	$import_to_blog=post_param_integer('import_to_blog',0);
	if (!$GLOBALS['FORUM_DRIVER']->is_super_admin(get_member())) $import_to_blog=0;

	$rss_url=post_param('rss_feed_url',NULL);
	require_code('uploads');
	if (((is_swf_upload(true)) && (array_key_exists('file_novalidate',$_FILES))) || ((array_key_exists('file_novalidate',$_FILES)) && (is_uploaded_file($_FILES['file_novalidate']['tmp_name']))))
	{
		$rss_url=$_FILES['file_novalidate']['tmp_name'];
	}
	if (is_null($rss_url))
		warn_exit(do_lang_tempcode('IMPROPERLY_FILLED_IN'));

	$rss=new rss($rss_url,true);

	if (!is_null($rss->error))
	{
		warn_exit($rss->error);
	}

	$imported_news=array();
	$imported_pages=array();

	// Preload news categories
	$NEWS_CATS=$GLOBALS['SITE_DB']->query_select('news_categories',array('*'),array('nc_owner'=>NULL));
	$NEWS_CATS=list_to_map('id',$NEWS_CATS);
	foreach ($rss->gleamed_items as $i=>$item)
	{
		// What is it, being imported?
		$is_news=true;
		if ((isset($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_TYPE'])) && ($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_TYPE']=='page'))
			$is_news=false;

		// Check for existing owner categories, if not create blog category for creator
		if (($to_own_account==0) && (array_key_exists('author',$item)))
		{
			$creator=$item['author'];
			$submitter_id=$GLOBALS['FORUM_DRIVER']->get_member_from_username($creator);
			if (is_null($submitter_id)) $submitter_id=get_member();
		} else
		{
			$submitter_id=get_member();
		}
		$author=array_key_exists('author',$item)?$item['author']:$GLOBALS['FORUM_DRIVER']->get_username(get_member());

		// Post name
		$post_name=$item['title'];
		if ((isset($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_NAME'])) && ($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_NAME']!=''))
		{
			$post_name=$item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_NAME'];
		}

		// Dates
		$add_date=array_key_exists('clean_add_date',$item)?$item['clean_add_date']:(array_key_exists('add_date',$item)?strtotime($item['add_date']):time());
		if ($add_date===false) $add_date=time(); // We've seen this situation in an error email, it's if the add date won't parse by PHP
		$edit_date=array_key_exists('clean_edit_date',$item)?$item['clean_edit_date']:(array_key_exists('edit_date',$item)?strtotime($item['edit_date']):NULL);
		if ($edit_date===false) $edit_date=NULL;
		if ($add_date>time()) $add_date=time();
		if ($add_date<0) $add_date=time();

		// Validation status
		$validated=$is_validated;
		if (isset($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:STATUS']))
		{
			if ($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:STATUS']=='publish')
				$validated=1;
			else
				$validated=0;
			if (!addon_installed('unvalidated')) $validated=1;
		}

		// Whether to allow comments
		$allow_comments=1;
		if (isset($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:COMMENT_STATUS']))
		{
			if ($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:COMMENT_STATUS']=='open')
				$allow_comments=1;
			else
				$allow_comments=0;
		}

		// Whether to allow trackbacks
		$allow_trackbacks=$is_news?1:0;
		if (isset($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:PING_STATUS']))
		{
			if ($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:PING_STATUS']!='open') $allow_trackbacks=0;
		}

		// Password
		$password='';
		if (isset($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_PASSWORD']))
		{
			$password=$item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_PASSWORD'];
		}

		// Categories
		if (!array_key_exists('category',$item)) $item['category']=do_lang('NC_general');
		$cats_to_process=array($item['category']);
		if (array_key_exists('extra_categories',$item))
			$cats_to_process=array_merge($cats_to_process,$item['extra_categories']);

		// Now import, whatever this is
		if ($is_news)
		{
			// Work out categories
			$owner_category_id=mixed();
			$cat_ids=array();
			foreach ($cats_to_process as $j=>$cat)
			{
				if ($cat=='Uncategorized') continue; // Skip blank category creation

				$cat_id=mixed();
				foreach ($NEWS_CATS as $_cat=>$news_cat)
				{				
					if (get_translated_text($news_cat['nc_title'])==$cat)
					{
						$cat_id=$_cat;					
					}
				}
				if (is_null($cat_id)) // Could not find existing category, create new
				{
					$cat_id=add_news_category($cat,'newscats/general','',NULL);
					// Need to reload now
					$NEWS_CATS=$GLOBALS['SITE_DB']->query_select('news_categories',array('*'),array('nc_owner'=>NULL));
					$NEWS_CATS=list_to_map('id',$NEWS_CATS);
				}

				if (($j==0) && ($import_to_blog==1))
				{
					$owner_category_id=$cat_id; // Primary
				} else
				{
					$cat_ids[]=$cat_id; // Secondary
				}
			}
			if (is_null($owner_category_id))
			{
				$owner_category_id=$GLOBALS['SITE_DB']->query_select_value_if_there('news_categories','id',array('nc_owner'=>$submitter_id));
			}

			// Work out rep-image
			$rep_image='';
			if (array_key_exists('rep_image',$item))
			{
				$rep_image=$item['rep_image'];
				if ($download_images==1)
				{
					$stem='uploads/grepimages/'.basename(urldecode($rep_image));
					$target_path=get_custom_file_base().'/'.$stem;
					$rep_image='uploads/grepimages/'.basename($rep_image);
					while (file_exists($target_path))
					{
						$uniqid=uniqid('');
						$stem='uploads/grepimages/'.$uniqid.'_'.basename(urldecode($rep_image));
						$target_path=get_custom_file_base().'/'.$stem;
						$rep_image='uploads/grepimages/'.$uniqid.'_'.basename($rep_image);
					}
					$target_handle=fopen($target_path,'wb') OR intelligent_write_error($target_path);
					$result=http_download_file($item['rep_image'],NULL,false,false,'ocPortal',NULL,NULL,NULL,NULL,NULL,$target_handle);
					fclose($target_handle);
				}
			}

			// Content
			$news=array_key_exists('news',$item)?import_foreign_news_html($item['news']):'';
			$news_article=array_key_exists('news_article',$item)?import_foreign_news_html($item['news_article']):'';
			if ($password!='')
			{
				$news_article='[highlight]'.do_lang('POST_ACCESS_IS_RESTRICTED').'[/highlight]'."\n\n".'[if_in_group="Administrators"]'.$news_article.'[/if_in_group]';
			}

			// Add news
			$id=add_news(
				$item['title'],
				$news,
				$author,
				$validated,
				1,
				$allow_comments,
				$allow_trackbacks,
				'',
				$news_article,
				$owner_category_id,
				$cat_ids,
				$add_date,
				$submitter_id,
				0,
				$edit_date,
				NULL,
				$rep_image
			);
			require_code('seo2');
			seo_meta_set_for_explicit('news',strval($id),implode(',',$cats_to_process),$news);

			// Track import IDs
			$rss->gleamed_items[$i]['import_id']=$id;
			$rss->gleamed_items[$i]['import__news']=$news;
			$rss->gleamed_items[$i]['import__news_article']=$news_article;
			$imported_news[]=$rss->gleamed_items[$i];

			// Needed for adding comments/trackbacks
			$comment_identifier='news_'.strval($id);
			$content_url=build_url(array('page'=>'news','type'=>'view','id'=>$id),get_module_zone('news'),NULL,false,false,true);
			$content_title=$item['title'];
			$trackback_for_type='news';
			$trackback_id=$id;
		} else
		{
			// If we don't have permission to write comcode pages, skip the page
			if (!has_submit_permission('high',get_member(),get_ip_address(),NULL,NULL)) continue;

			// Save articles as new comcode pages
			$zone='site';
			$lang=fallback_lang();
			$file=preg_replace('#[^\w\-]#','_',$post_name); // Filter non alphanumeric charactors
			$fullpath=zone_black_magic_filterer(get_custom_file_base().'/'.$zone.'/pages/comcode_custom/'.$lang.'/'.$file.'.txt');

			// Content
			$_content="[title]".comcode_escape($item['title'])."[/title]\n\n";
			$_content.='[surround]'.import_foreign_news_html(array_key_exists('news_article',$item)?$item['news_article']:$item['news']).'[/surround]';
			$_content.="\n\n[block]main_comcode_page_children[/block]";
			if ($allow_comments==1)
			{
				$_content.="\n\n[block=\"main\"]main_comments[/block]";
			}
			if ($allow_trackbacks==1)
			{
				$_content.="\n\n[block id=\"0\"]main_trackback[/block]";
			}

			// Add to the database
			$GLOBALS['SITE_DB']->query_delete('comcode_pages',array(
				'the_zone'=>$zone,
				'the_page'=>$file,
			),'',1);
			$GLOBALS['SITE_DB']->query_insert('comcode_pages',array(
				'the_zone'=>$zone,
				'the_page'=>$file,
				'p_parent_page'=>'',
				'p_validated'=>$validated,
				'p_edit_date'=>$edit_date,
				'p_add_date'=>$add_date,
				'p_submitter'=>$submitter_id,
				'p_show_as_edit'=>0
			));

			// Save to disk
			$myfile=@fopen($fullpath,'wt');
			if ($myfile===false) intelligent_write_error($fullpath);
			if (fwrite($myfile,$_content)<strlen($_content)) warn_exit(do_lang_tempcode('COULD_NOT_SAVE_FILE'));
			fclose($myfile);
			sync_file($fullpath);

			// Meta
			require_code('seo2');
			seo_meta_set_for_explicit('comcode_page',$zone.':'.$file,implode(',',$cats_to_process),'');

			// Track import IDs etc
			$parent_page=mixed();
			if (isset($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_PARENT']))
			{
				$parent_page=intval($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_PARENT']);
				if ($parent_page==0) $parent_page=NULL;
			}
			$page_id=mixed();
			if (isset($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_ID']))
			{
				$page_id=intval($item['extra']['HTTP://WORDPRESS.ORG/EXPORT/1.2/:POST_ID']);
			}
			$imported_pages[]=array(
				'contents'=>$_content,
				'zone'=>$zone,
				'page'=>$file,
				'path'=>$fullpath,
				'parent_page'=>$parent_page,
				'id'=>$page_id,
			);

			// Restricted access
			if ($password!='')
			{
				$usergroups=$GLOBALS['FORUM_DRIVER']->get_usergroup_list();
				foreach (array_keys($usergroups) as $group_id)
				{
					$GLOBALS['SITE_DB']->query_delete('group_page_access',array('page_name'=>$file,'zone_name'=>$zone,'group_id'=>$group_id),'',1);
					$GLOBALS['SITE_DB']->query_insert('group_page_access',array('page_name'=>$file,'zone_name'=>$zone,'group_id'=>$group_id));
				}
			}

			// Needed for adding comments/trackbacks
			$comment_identifier=$file.'_main';
			$content_url=build_url(array('page'=>$file),$zone,NULL,false,false,true);
			$content_title=$item['title'];
			$trackback_for_type=$file;
			$trackback_id=0;
		}

		// Add comments
		if ($import_blog_comments==1)
		{
			if (array_key_exists('comments',$item))
			{
				$comment_mapping=array();
				foreach ($item['comments'] as $comment)
				{
					if (!array_key_exists('COMMENT_CONTENT',$comment)) continue;

					$comment_content=import_foreign_news_html($comment['COMMENT_CONTENT']);
					$comment_author=array_key_exists('COMMENT_AUTHOR',$comment)?$comment['COMMENT_AUTHOR']:do_lang('GUEST');
					$comment_parent=array_key_exists('COMMENT_PARENT',$comment)?$comment['COMMENT_PARENT']:'';
					$comment_date_gmt=array_key_exists('COMMENT_DATE_GMT',$comment)?$comment['COMMENT_DATE_GMT']:date('D/m/Y H:i:s',time());
					$author_ip=array_key_exists('COMMENT_AUTHOR_IP',$comment)?$comment['COMMENT_AUTHOR_IP']:get_ip_address();
					$comment_approved=array_key_exists('COMMENT_APPROVED',$comment)?$comment['COMMENT_APPROVED']:'1';
					$comment_id=array_key_exists('COMMENT_ID',$comment)?$comment['COMMENT_ID']:'';
					$comment_type=array_key_exists('COMMENT_TYPE',$comment)?$comment['COMMENT_TYPE']:'';

					$comment_author_url=array_key_exists('COMMENT_AUTHOR_URL',$comment)?$comment['COMMENT_AUTHOR_URL']:'';
					$comment_author_email=array_key_exists('COMMENT_AUTHOR_EMAIL',$comment)?$comment['COMMENT_AUTHOR_EMAIL']:'';

					$comment_add_date=strtotime($comment_date_gmt);
					if ($comment_add_date>time()) $comment_add_date=time();
					if ($comment_add_date<0) $comment_add_date=time();

					if (($comment_type=='trackback') || ($comment_type=='pingback'))
					{
						$GLOBALS['SITE_DB']->query_insert('trackbacks',array(
							'trackback_for_type'=>$trackback_for_type,
							'trackback_for_id'=>strval($trackback_id),
							'trackback_ip'=>$author_ip,
							'trackback_time'=>$comment_add_date,
							'trackback_url'=>$comment_author_url,
							'trackback_title'=>'',
							'trackback_excerpt'=>$comment_content,
							'trackback_name'=>$comment_author,
						));
						continue;
					}

					if ($comment_author_url!='')
						$comment_content.="\n\n".do_lang('WEBSITE').': [url]'.$comment_author_url.'[/url]';
					if ($comment_author_email!='')
						$comment_content.="[staff_note]\n\n".do_lang('EMAIL').': [email]'.$comment_author_email."[/email][/staff_note]";

					$submitter=$GLOBALS['FORUM_DB']->query_select_value_if_there('f_members','id',array('m_username'=>$comment_author));
					if (is_null($submitter)) $submitter=$GLOBALS['FORUM_DRIVER']->get_guest_id(); // If comment is made by a non-member, assign comment to guest account

					$forum=(is_null(get_value('comment_forum__news')))?get_option('comments_forum_name'):get_value('comment_forum__news');

					$comment_parent_id=mixed();
					if ((get_forum_type()=='ocf') && (!is_null($comment_parent)) && (isset($comment_mapping[$comment_parent])))
					{
						$comment_parent_id=$comment_mapping[$comment_parent];
					}
					if ($comment_parent_id==0) $comment_parent_id=NULL;

					$result=$GLOBALS['FORUM_DRIVER']->make_post_forum_topic(
						$forum,
						$comment_identifier,
						$submitter,
						'', // Would be post title
						$comment_content,
						$content_title,
						do_lang('COMMENT'),
						$content_url->evaluate(),
						$comment_add_date,
						$author_ip,
						intval($comment_approved),
						1,
						false,
						$comment_author,
						$comment_parent_id
					);

					if (get_forum_type()=='ocf')
					{
						$comment_mapping[$comment_id]=$GLOBALS['LAST_POST_ID'];
					}
				}
			}
		}
	}

	// Download images etc
	foreach ($imported_news as $item)
	{
		$news=$item['import__news'];
		$news_article=$item['import__news_article'];
		_news_import_grab_images_and_fix_links($download_images==1,$news,$imported_news);
		_news_import_grab_images_and_fix_links($download_images==1,$news_article,$imported_news);
		lang_remap_comcode($GLOBALS['SITE_DB']->query_select_value('news','news',array('id'=>$item['import_id'])),$news);
		lang_remap_comcode($GLOBALS['SITE_DB']->query_select_value('news','news_article',array('id'=>$item['import_id'])),$news_article);
	}
	foreach ($imported_pages as $item)
	{
		$contents=$item['contents'];
		$zone=$item['zone'];
		$page=$item['page'];
		_news_import_grab_images_and_fix_links($download_images==1,$contents,$imported_news);
		$myfile=fopen($item['path'],'wb');
		fwrite($myfile,$contents);
		fclose($myfile);
		if (!is_null($item['parent_page']))
		{
			$parent_page=mixed();
			foreach ($imported_pages as $item2)
			{
				if ($item2['id']==$item['parent_page']) $parent_page=$item2['page'];
			}
			if (!is_null($parent_page))
			{
				$GLOBALS['SITE_DB']->query_update('comcode_pages',array('p_parent_page'=>$parent_page),array('the_zone'=>$zone,'the_page'=>$page),'',1);
			}
		}
	}

	// Cleanup
	if (url_is_local($rss_url)) // Means it is a temp file
		@unlink($rss_url);
}

/*
DIRECT WORDPRESS DATABASE IMPORT (imports more than RSS import can)
*/

/**
 * Import wordpress DB
 */
function import_wordpress_db()
{
	disable_php_memory_limit();
	if (function_exists('set_time_limit')) @set_time_limit(0);

	$GLOBALS['LAX_COMCODE']=true;

	$data=_get_wordpress_db_data();
	$is_validated=post_param_integer('wp_auto_validate',0);
	if (!addon_installed('unvalidated')) $is_validated=1;
	$download_images=post_param_integer('wp_download_images',0);
	if (!has_privilege(get_member(),'draw_to_server')) $download_images=0;
	$to_own_account=post_param_integer('wp_add_to_own',0);
	if (!$GLOBALS['FORUM_DRIVER']->is_super_admin(get_member())) $to_own_account=0;
	$import_blog_comments=post_param_integer('wp_import_blog_comments',0);
	$import_to_blog=post_param_integer('wp_import_to_blog',0);
	if (!$GLOBALS['FORUM_DRIVER']->is_super_admin(get_member())) $import_to_blog=0;

	if (get_forum_type()=='ocf')
	{
		require_code('ocf_members_action');
		require_code('ocf_groups');

		$def_grp_id=get_first_default_group();
	}

	$cat_id=array();

	$NEWS_CATS=$GLOBALS['SITE_DB']->query_select('news_categories',array('*'),array('nc_owner'=>NULL));
	$NEWS_CATS=list_to_map('id',$NEWS_CATS);

	$imported_news=array();
	$imported_pages=array();

	foreach ($data as $values)
	{
		// Lookup/import member
		if ($to_own_account==1)
		{
			// If post should go to own account
			$submitter_id=get_member();
		} else
		{
			if (get_forum_type()=='ocf')
			{
				$submitter_id=$GLOBALS['FORUM_DB']->query_select_value_if_there('f_members','id',array('m_username'=>$values['user_login']));

				if (is_null($submitter_id))
				{
					if (post_param_integer('wp_import_wordpress_users',0)==1)
					{
						$submitter_id=ocf_make_member($values['user_login'],$values['user_pass'],'',NULL,NULL,NULL,NULL,array(),NULL,$def_grp_id,1,time(),time(),'',NULL,'',0,0,1,'','','',1,0,NULL,1,1,'','',NULL,'',false,'wordpress');
					} else
					{
						$submitter_id=$GLOBALS['FORUM_DRIVER']->get_member_from_username('admin');	// Set admin as owner
						if (is_null($submitter_id)) $submitter_id=$GLOBALS['FORUM_DRIVER']->get_guest_id()+1;
					}
				}
			} else
			{
				$submitter_id=$GLOBALS['FORUM_DRIVER']->get_guest_id(); // Guest user
			}
		}

		if (array_key_exists('POSTS',$values))
		{
			// Create news and pages
			foreach ($values['POSTS'] as $post_id=>$post)
			{
				// Validation status
				$validated=$is_validated;
				if ($post['post_status']=='publish')
					$validated=1;
				else
					$validated=0;
				if (!addon_installed('unvalidated')) $validated=1;

				// Allow comments/trackbacks
				$allow_comments=($post['comment_status']=='open')?1:0;
				$allow_trackbacks=($post['ping_status']=='open')?1:0;

				if ($post['post_type']=='post') // News
				{
					// Work out categories
					$owner_category_id=mixed();
					$cat_ids=array();
					if (array_key_exists('category',$post))
					{
						$i=0;
						foreach ($post['category'] as $category)
						{
							if ($category=='Uncategorized') continue;	// Skip blank category creation

							$cat_id=mixed();
							foreach ($NEWS_CATS as $id=>$existing_cat)
							{
								if (get_translated_text($existing_cat['nc_title'])==$category)
								{
									$cat_id=$id;
								}
							}
							if (is_null($cat_id)) // Could not find existing category, create new
							{
								$cat_id=add_news_category($category,'newscats/community',$category);
								// Need to reload now
								$NEWS_CATS=$GLOBALS['SITE_DB']->query_select('news_categories',array('*'));
								$NEWS_CATS=list_to_map('id',$NEWS_CATS);
							}
							if (($i==0) && ($import_to_blog==1))
							{
								$owner_category_id=$cat_id; // Primary
							} else
							{
								$cat_ids[]=$cat_id; // Secondary
							}
							$i++;
						}
					}
					if (is_null($owner_category_id))
					{
						$owner_category_id=$GLOBALS['SITE_DB']->query_select_value_if_there('news_categories','id',array('nc_owner'=>$submitter_id));
					}

					// Content
					$news='';
					$news_article=import_foreign_news_html($post['post_content']);
					if ($post['post_password']!='')
					{
						$news_article='[highlight]'.do_lang('POST_ACCESS_IS_RESTRICTED').'[/highlight]'."\n\n".'[if_in_group="Administrators"]'.$news_article.'[/if_in_group]';
					}

					// Add news
					$id=add_news(
						$post['post_title'],
						$news,
						NULL,
						$validated,
						1,
						$allow_comments,
						$allow_trackbacks,
						'',
						$news_article,
						$owner_category_id,
						$cat_ids,
						strtotime($post['post_date_gmt']),
						$submitter_id,
						0,
						is_null($post['post_modified_gmt'])?NULL:strtotime($post['post_modified_gmt']),
						NULL,
						''
					);
					if (array_key_exists('category',$post))
					{
						require_code('seo2');
						seo_meta_set_for_explicit('news',strval($id),implode(',',$post['category']),$news);
					}

					// Needed for adding comments/trackbacks
					$comment_identifier='news_'.strval($id);
					$content_url=build_url(array('page'=>'news','type'=>'view','id'=>$id),get_module_zone('news'),NULL,false,false,true);
					$content_title=$post['post_title'];
					$trackback_for_type='news';
					$trackback_id=$id;

					// Track import IDs
					$imported_news[]=array(
						//'full_url'=>'', We don't know this for a database import
						'import_id'=>$id,
						'import__news'=>$news,
						'import__news_article'=>$news_article,
					);
				}
				elseif ($post['post_type']=='page') // Page/articles
				{
					// If we don't have permission to write comcode pages, skip the page
					if (!has_submit_permission('high',get_member(),get_ip_address(),NULL,NULL)) continue;

					// Save articles as new comcode pages
					$zone='site';
					$lang=fallback_lang();
					$file=preg_replace('#[^\w\-]#','_',$post['post_name']); // Filter non alphanumeric charactors
					$fullpath=zone_black_magic_filterer(get_custom_file_base().'/'.$zone.'/pages/comcode_custom/'.$lang.'/'.$file.'.txt');

					// Content
					$_content="[title]".comcode_escape($post['post_title'])."[/title]\n\n";
					$_content.='[surround]'.import_foreign_news_html($post['post_content']).'[/surround]';
					$_content.="\n\n[block]main_comcode_page_children[/block]";
					if ($allow_comments==1)
					{
						$_content.="\n\n[block=\"main\"]main_comments[/block]";
					}
					if ($allow_trackbacks==1)
					{
						$_content.="\n\n[block id=\"0\"]main_trackback[/block]";
					}

					// Add to the database
					$GLOBALS['SITE_DB']->query_delete('comcode_pages',array(
						'the_zone'=>$zone,
						'the_page'=>$file,
					),'',1);
					$GLOBALS['SITE_DB']->query_insert('comcode_pages',array(
						'the_zone'=>$zone,
						'the_page'=>$file,
						'p_parent_page'=>'',
						'p_validated'=>$is_validated,
						'p_edit_date'=>strtotime($post['post_modified_gmt']),
						'p_add_date'=>strtotime($post['post_date_gmt']),
						'p_submitter'=>$submitter_id,
						'p_show_as_edit'=>0
					));

					// Save to disk
					$myfile=@fopen($fullpath,'wt');
					if ($myfile===false) intelligent_write_error($fullpath);
					if (fwrite($myfile,$_content)<strlen($_content)) warn_exit(do_lang_tempcode('COULD_NOT_SAVE_FILE'));
					fclose($myfile);
					sync_file($fullpath);

					// Meta
					if (array_key_exists('category',$post))
					{
						require_code('seo2');
						seo_meta_set_for_explicit('comcode_page',$zone.':'.$file,implode(',',$post['category']),'');
					}

					// Track import IDs etc
					$parent_page=$post['post_parent'];
					if ($parent_page==0) $parent_page=NULL;
					$imported_pages[]=array(
						'contents'=>$_content,
						'zone'=>$zone,
						'page'=>$file,
						'path'=>$fullpath,
						'parent_page'=>$parent_page,
						'id'=>$post['post_id'],
					);

					// Restricted access
					if ($post['post_password']!='')
					{
						$usergroups=$GLOBALS['FORUM_DRIVER']->get_usergroup_list();
						foreach (array_keys($usergroups) as $group_id)
						{
							$GLOBALS['SITE_DB']->query_delete('group_page_access',array('page_name'=>$file,'zone_name'=>$zone,'group_id'=>$group_id),'',1);
							$GLOBALS['SITE_DB']->query_insert('group_page_access',array('page_name'=>$file,'zone_name'=>$zone,'group_id'=>$group_id));
						}
					}

					// Needed for adding comments/trackbacks
					$comment_identifier=$file.'_main';
					$content_url=build_url(array('page'=>$file),$zone,NULL,false,false,true);
					$content_title=$post['post_title'];
					$trackback_for_type=$file;
					$trackback_id=0;
				}

				// Add comments
				if ($import_blog_comments==1)
				{
					if (array_key_exists('COMMENTS',$post))
					{
						$comment_mapping=array();
						foreach ($post['COMMENTS'] as $comment)
						{
							$submitter=$GLOBALS['FORUM_DB']->query_select_value_if_there('f_members','id',array('m_username'=>$comment['comment_author']));
							if (is_null($submitter)) $submitter=$GLOBALS['FORUM_DRIVER']->get_guest_id(); // If comment is made by a non-member, assign comment to guest account

							$forum=(is_null(get_value('comment_forum__news')))?get_option('comments_forum_name'):get_value('comment_forum__news');

							$comment_parent_id=mixed();
							if ((get_forum_type()=='ocf') && (!is_null($comment['comment_parent'])) && (isset($comment_mapping[$comment['comment_parent']])))
							{
								$comment_parent_id=$comment_mapping[$comment['comment_parent']];
							}
							if ($comment_parent_id==0) $comment_parent_id=NULL;

							$comment_content=import_foreign_news_html($comment['comment_content']);

							$comment_author_url=$comment['comment_author_url'];
							$comment_author_email=$comment['comment_author_email'];

							$comment_type=$comment['comment_type'];
							if (($comment_type=='trackback') || ($comment_type=='pingback'))
							{
								$GLOBALS['SITE_DB']->query_insert('trackbacks',array(
									'trackback_for_type'=>$trackback_for_type,
									'trackback_for_id'=>strval($trackback_id),
									'trackback_ip'=>$comment['author_ip'],
									'trackback_time'=>strtotime($comment['comment_date_gmt']),
									'trackback_url'=>$comment_author_url,
									'trackback_title'=>'',
									'trackback_excerpt'=>$comment_content,
									'trackback_name'=>$comment['comment_author'],
								));
								continue;
							}

							if ($comment_author_url!='')
								$comment_content.="\n\n".do_lang('WEBSITE').': [url]'.$comment_author_url.'[/url]';
							if ($comment_author_email!='')
								$comment_content.="[staff_note]\n\n".do_lang('EMAIL').': [email]'.$comment_author_email."[/email][/staff_note]";

							$result=$GLOBALS['FORUM_DRIVER']->make_post_forum_topic(
								$forum,
								'news_'.strval($id),
								$submitter,
								'', // Would be post title
								$comment_content,
								$content_title,
								do_lang('COMMENT'),
								$content_url->evaluate(),
								strtotime($comment['comment_date_gmt']),
								$comment['author_ip'],
								$comment['comment_approved'],
								1,
								false,
								$comment['comment_author'],
								$comment_parent_id
							);

							if (get_forum_type()=='ocf')
							{
								$comment_mapping[$comment['comment_ID']]=$GLOBALS['LAST_POST_ID'];
							}
						}
					}
				}
			}
		}
	}

	// Download images etc
	foreach ($imported_news as $item)
	{
		$news=$item['import__news'];
		$news_article=$item['import__news_article'];
		_news_import_grab_images_and_fix_links($download_images==1,$news,$imported_news);
		_news_import_grab_images_and_fix_links($download_images==1,$news_article,$imported_news);
		lang_remap_comcode($GLOBALS['SITE_DB']->query_select_value('news','news',array('id'=>$item['import_id'])),$news);
		lang_remap_comcode($GLOBALS['SITE_DB']->query_select_value('news','news_article',array('id'=>$item['import_id'])),$news_article);
	}
	foreach ($imported_pages as $item)
	{
		$contents=$item['contents'];
		$zone=$item['zone'];
		$page=$item['page'];
		_news_import_grab_images_and_fix_links($download_images==1,$contents,$imported_news);
		$myfile=fopen($item['path'],'wb');
		fwrite($myfile,$contents);
		fclose($myfile);
		if (!is_null($item['parent_page']))
		{
			$parent_page=mixed();
			foreach ($imported_pages as $item2)
			{
				if ($item2['id']==$item['parent_page']) $parent_page=$item2['page'];
			}
			if (!is_null($parent_page))
			{
				$GLOBALS['SITE_DB']->query_update('comcode_pages',array('p_parent_page'=>$parent_page),array('the_zone'=>$zone,'the_page'=>$page),'',1);
			}
		}
	}
}

/**
 * Get data from the Wordpress DB
 *
 * @return array		Result structure
 */
function _get_wordpress_db_data()
{
	$host_name=post_param('wp_host');
	$db_name=post_param('wp_db');
	$db_user=post_param('wp_db_user');
	$db_passwrod=post_param('wp_db_password');
	$db_table_prefix=post_param('wp_table_prefix');

	// Create DB connection
	$db=new database_driver($db_name,$host_name,$db_user,$db_passwrod,$db_table_prefix);

	$users=$db->query('SELECT * FROM '.db_escape_string($db_name).'.'.db_escape_string($db_table_prefix).'_users');

	$data=array();
	foreach ($users as $user)
	{
		$user_id=$user['ID'];
		$data[$user_id]=$user;

		// Fetch user posts/pages
		$posts=$db->query('SELECT * FROM '.$db_table_prefix.'_posts WHERE post_author='.strval($user_id).' AND (post_type=\'post\' OR post_type=\'page\')');
		foreach ($posts as $post)
		{
			$post_id=$post['ID'];
			$data[$user_id]['POSTS'][$post_id]=$post;

			// Get categories
			$categories=$db->query('SELECT t1.slug,t1.name FROM '.$db_table_prefix.'_terms t1 JOIN '.db_escape_string($db_name).'.'.db_escape_string($db_table_prefix).'_term_taxonomy t2 ON t1.term_id=t2.term_id JOIN '.db_escape_string($db_name).'.'.db_escape_string($db_table_prefix).'_term_relationships t3 ON t2.term_taxonomy_id=t3.term_taxonomy_id WHERE t3.object_id='.strval($post_id).' ORDER BY t3.term_order');
			foreach ($categories as $category)
			{
				$data[$user_id]['POSTS'][$post_id]['category'][$category['slug']]=$category['name'];
			}

			// Comments
			$comments=$db->query('SELECT * FROM '.$db_table_prefix.'_comments WHERE comment_post_ID='.strval($post_id).' ORDER BY comment_date_gmt');
			foreach ($comments as $comment)
			{
				$comment_id=$comment['comment_ID'];
				$data[$user_id]['POSTS'][$post_id]['COMMENTS'][$comment_id]=$comment;
			}
		}
	}

	return $data;
}

/*
NEWS IMPORT UTILITY FUNCTIONS
*/

/**
 * Get data from wordpress DB.
 *
 * @param  string		HTML
 * @return string		Comcode
 */
function import_foreign_news_html($html)
{
	// Wordpress images
	$matches=array();
	$num_matches=preg_match_all('#\[caption id="(\w+)" align="align(left|right|center|none)" width="(\d+)"\](.*)\[/caption\]#Us',$html,$matches);
	for ($i=0;$i<$num_matches;$i++)
	{
		$test=strpos($matches[4][$i],' /></a> ');
		if ($test!==false)
		{
			$matches[4][$i]=substr($matches[4][$i],0,$test).' /></a> <p class="wp-caption-text">'.substr($matches[4][$i],$test+strlen(' /></a> ')).'</p>';
		} else
		{
			$test=strpos($matches[4][$i],' /> ');
			if ($test!==false)
			{
				$matches[4][$i]=substr($matches[4][$i],0,$test).' /> <p class="wp-caption-text">'.substr($matches[4][$i],$test+strlen(' /> ')).'</p>';
			}
		}
		$new='[surround="attachment wp-caption align'.$matches[2][$i].' '.$matches[1][$i].'" style="width: '.$matches[3][$i].'px"]'.$matches[4][$i].'[/surround]';
		$html=str_replace($matches[0][$i],$new,$html);
	}
	$html=preg_replace('#<a([^>]*)><img #','<a rel="lightbox"${1}><img ',$html);

	// Blogger images
	$html=str_replace('imageanchor="1"','rel="lightbox"',$html);

	// General conversion to Comcode
	require_code('comcode_from_html');
	return semihtml_to_comcode($html,false);
}

/**
 * Download remote images in some HTML and replace with local references under uploads/website_specific AND fix any links to other articles being imported to make them local links.
 *
 * @param  boolean		Whether to download images to local
 * @param  string			HTML (passed by reference)
 * @param  array			Imported items, in ocPortal's RSS-parsed format [list of maps containing full_url and import_id] (used to fix links)
 */
function _news_import_grab_images_and_fix_links($download_images,&$data,$imported_news)
{
	$matches=array();
	if ($download_images)
	{
		$num_matches=preg_match_all('#<img[^<>]*\ssrc=["\']([^\'"]*)["\']#i',$data,$matches); // If there's an <a> to the same URL, this will be replaced too
		for ($i=0;$i<$num_matches;$i++)
			_news_import_grab_image($data,$matches[1][$i]);
		$num_matches=preg_match_all('#<a[^<>]*\s*href=["\']([^\'"]*)["\']\s*imageanchor=["\']1["\']#i',$data,$matches);
		for ($i=0;$i<$num_matches;$i++)
			_news_import_grab_image($data,$matches[1][$i]);
		$num_matches=preg_match_all('#<a rel="lightbox" href=["\']([^\'"]*)["\']#i',$data,$matches);
		for ($i=0;$i<$num_matches;$i++)
			_news_import_grab_image($data,$matches[1][$i]);
	}

	// Go through other items, in case this news article/page is linking to them and needs a fixed link
	foreach ($imported_news as $item)
	{
		if (array_key_exists('full_url',$item))
		{
			$num_matches=preg_match_all('#<a\s*([^<>]*)href="'.str_replace('#','\#',preg_quote(escape_html($item['full_url']))).'"([^<>]*)>(.*)</a>#isU',$data,$matches);
			for ($i=0;$i<$num_matches;$i++)
			{
				if (($matches[1][$i]=='') && ($matches[2][$i]=='') && (strpos($data,'[html]')===false))
				{
					$data=str_replace($matches[0][$i],'[page="_SEARCH:news:view:'.strval($item['import_id']).'"]'.$matches[3][$i].'[/page]',$data);
				} else
				{
					$new_url=build_url(array('page'=>'news','type'=>'view','id'=>$item['import_id']),get_module_zone('news'),NULL,false,false,true);
					$data=str_replace($matches[0][$i],'<a '.$matches[1][$i].'href="'.escape_html($new_url->evaluate()).'"'.$matches[2][$i].'>'.$matches[3][$i].'</a>',$data);
				}
			}
		}
	}
}

/**
 * Download a specific remote image and sub in the new URL.
 *
 * @param  string			HTML (passed by reference)
 * @param  URLPATH		URL
 */
function _news_import_grab_image(&$data,$url)
{
	$url=qualify_url($url,get_base_url());
	if (substr($url,0,strlen(get_custom_base_url().'/'))==get_custom_base_url().'/') return;
	require_code('images');
	if (!is_image($url)) return;

	$stem='uploads/attachments/'.basename(urldecode($url));
	$target_path=get_custom_file_base().'/'.$stem;
	$target_url=get_custom_base_url().'/uploads/attachments/'.basename($url);
	while (file_exists($target_path))
	{
		$uniqid=uniqid('');
		$stem='uploads/attachments/'.$uniqid.'_'.basename(urldecode($url));
		$target_path=get_custom_file_base().'/'.$stem;
		$target_url=get_custom_base_url().'/uploads/attachments/'.$uniqid.'_'.basename($url);
	}

	$target_handle=fopen($target_path,'wb') OR intelligent_write_error($target_path);
	$result=http_download_file($url,NULL,false,false,'ocPortal',NULL,NULL,NULL,NULL,NULL,$target_handle);
	fclose($target_handle);
	if (!is_null($result))
	{
		$data=str_replace('"'.$url.'"',$target_url,$data);
		$data=str_replace('"'.preg_replace('#^http://.*/#U','/',$url).'"',$target_url,$data);
		$data=str_replace('\''.$url.'\'',$target_url,$data);
		$data=str_replace('\''.preg_replace('#^http://.*/#U','/',$url).'\'',$target_url,$data);
	}
}
