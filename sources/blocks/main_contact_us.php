<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2011

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		staff_messaging
 */

class Block_main_contact_us
{

	/**
	 * Standard modular info function.
	 *
	 * @return ?array	Map of module info (NULL: module is disabled).
	 */
	function info()
	{
		$info=array();
		$info['author']='Chris Graham';
		$info['organisation']='ocProducts';
		$info['hacked_by']=NULL;
		$info['hack_version']=NULL;
		$info['version']=2;
		$info['locked']=false;
		$info['parameters']=array('param','title','email_optional');
		return $info;
	}

	/**
	 * Standard modular run function.
	 *
	 * @param  array		A map of parameters.
	 * @return tempcode	The result of execution.
	 */
	function run($map)
	{
		require_lang('messaging');
		require_code('feedback');

		$type=array_key_exists('param',$map)?$map['param']:do_lang('GENERAL');

		if (has_actual_page_access(get_member(),'admin_messaging'))
		{
			if (post_param_integer('enable_tracking',0)==1)
			{
				$GLOBALS['SITE_DB']->query_insert('tracking',array(
					'r_resource_type'=>'messaging',
					'r_resource_id'=>$type,
					'r_member_id'=>get_member(),
					'r_notify_sms'=>0,
					'r_notify_email'=>1,
					'r_filter'=>''
				));
			}
			elseif (post_param_integer('disable_tracking',0)==1)
			{
				$GLOBALS['SITE_DB']->query_delete('tracking',array(
					'r_resource_type'=>'messaging',
					'r_resource_id'=>$type,
					'r_member_id'=>get_member()
				),'',1);
			}
		}

		$id=uniqid('');
		$_self_url=build_url(array('page'=>'admin_messaging','type'=>'view','id'=>$id,'message_type'=>$type),get_module_zone('admin_messaging'));
		$self_url=$_self_url->evaluate();
		$self_title=post_param('title',do_lang('CONTACT_US_MESSAGING'));
		$post=post_param('post','');
		$title=post_param('title','');

		$box_title=array_key_exists('title',$map)?$map['title']:do_lang('CONTACT_US');

		if ((post_param_integer('_comment_form_post',0)==1) && ($post!=''))
		{
			$message=new ocp_tempcode();/*Used to be written out here*/ attach_message(do_lang_tempcode('MESSAGE_SENT'),'inform');

			// Handle tracking
			require_code('database_search');
			$tracking_addresses=array(get_option('staff_address'));
			$tracking_sms=array();
			$trackers=$GLOBALS['SITE_DB']->query_select('tracking',array('*'),array('r_resource_type'=>'messaging','r_resource_id'=>$type));
			foreach ($trackers as $myrow)
			{
				if (has_actual_page_access($myrow['r_member_id'],'admin_messaging'))
				{
					if (($myrow['r_filter']!='') && (!in_memory_search_match(unserialize($myrow['r_filter']),$title,$post))) continue;

					if ($myrow['r_notify_sms']==1)
					{
						$tracking_sms[]=$myrow['r_member_id']; // sms_wrap will handle working out phone numbers or bridging
					}
					if ($myrow['r_notify_email']==1)
					{
						$tracking_addresses[]=$GLOBALS['FORUM_DRIVER']->get_member_email_address($myrow['r_member_id']);
					}
				}
			}
			require_code('mail');
			$msg=do_lang('CONTACT_US_TRACKING_MESSAGE',comcode_escape(get_site_name()),$self_url,array(comcode_escape($GLOBALS['FORUM_DRIVER']->get_username(get_member())),$post,comcode_escape($type)),get_site_default_lang());
			mail_wrap(do_lang('CONTACT_US_TRACKING_SUBJECT',$title,NULL,NULL,get_site_default_lang()),$msg,$tracking_addresses,NULL,$GLOBALS['FORUM_DRIVER']->get_member_email_address(get_member()),$GLOBALS['FORUM_DRIVER']->get_username(get_member()),3,NULL,false,get_member());
			sms_wrap(do_lang('CONTACT_US_TRACKING_SMS',$title,get_site_name(),$type,get_site_default_lang()),$tracking_sms);

			$email_from=trim(post_param('email',$GLOBALS['FORUM_DRIVER']->get_member_email_address(get_member())));
			if ($email_from!='')
			{
				mail_wrap(do_lang('YOUR_MESSAGE_WAS_SENT_SUBJECT',$title),do_lang('YOUR_MESSAGE_WAS_SENT_BODY',$post),array($email_from),NULL,'','',3,NULL,false,get_member());
			}

			do_comments(true,$type,$id,$self_url,$self_title,get_option('messaging_forum_name'),(get_option('captcha_on_feedback')=='0'),1,true,true);
		} else
		{
			$message=new ocp_tempcode();
		}

		if (!has_no_forum())
		{
			// Comment posts
			$forum=get_option('messaging_forum_name');
			$count=0;
			$_comments=$GLOBALS['FORUM_DRIVER']->get_forum_topic_posts($forum,$type.'_'.$id,'',$count);

			if ($_comments!==-1)
			{
				$em=$GLOBALS['FORUM_DRIVER']->get_emoticon_chooser();
				require_javascript('javascript_editing');
				$comcode_help=build_url(array('page'=>'userguide_comcode'),get_comcode_zone('userguide_comcode',false));
				require_javascript('javascript_validation');
				$comment_url=get_self_url();
				$email_optional=array_key_exists('email_optional',$map)?(intval($map['email_optional'])==1):true;

				if (addon_installed('captcha'))
				{
					require_code('captcha');
					$use_captcha=((get_option('captcha_on_feedback')=='1') && (use_captcha()));
					if ($use_captcha)
					{
						generate_captcha();
					}
				} else $use_captcha=false;

				$comment_details=do_template('COMMENTS',array('JOIN_BITS'=>'','FIRST_POST_URL'=>'','FIRST_POST'=>'','USE_CAPTCHA'=>$use_captcha,'EMAIL_OPTIONAL'=>$email_optional,'POST_WARNING'=>'','COMMENT_TEXT'=>'','GET_EMAIL'=>true,'GET_TITLE'=>true,'EM'=>$em,'DISPLAY'=>'block','COMMENT_URL'=>$comment_url,'TITLE'=>$box_title));

				$tracking=NULL;
				$tracking_url=NULL;
				if (has_actual_page_access(get_member(),'admin_messaging'))
				{
					$tracking=!is_null($GLOBALS['SITE_DB']->query_value_null_ok('tracking','r_resource_type',array('r_resource_type'=>'messaging','r_resource_id'=>$type,'r_member_id'=>get_member())));
					$tracking_url=get_self_url();
				}

				$out=do_template('BLOCK_MAIN_CONTACT_US',array('_GUID'=>'fd269dce5ff984ee558e9052fa0150b0','COMMENT_DETAILS'=>$comment_details,'MESSAGE'=>$message,'TRACKING'=>$tracking,'TRACKING_URL'=>$tracking_url));
			} else $out=new ocp_tempcode();
		} else $out=new ocp_tempcode();

		return $out;
	}

}


