<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2013

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		points
 */

/**
 * Module page class.
 */
class Module_leader_board
{

	/**
	 * Standard modular info function.
	 *
	 * @return ?array	Map of module info (NULL: module is disabled).
	 */
	function info()
	{
		$info=array();
		$info['author']='Chris Graham';
		$info['organisation']='ocProducts';
		$info['hacked_by']=NULL;
		$info['hack_version']=NULL;
		$info['version']=2;
		$info['locked']=false;
		return $info;
	}

	/**
	 * Standard modular entry-point finder function.
	 *
	 * @return ?array	A map of entry points (type-code=>language-code) (NULL: disabled).
	 */
	function get_entry_points()
	{
		return array('!'=>'POINT_LEADERBOARD');
	}

	/**
	 * Standard modular run function.
	 *
	 * @return tempcode	The result of execution.
	 */
	function run()
	{
		require_lang('leader_board');
		require_code('points');
		require_css('points');

		$title=get_screen_title('POINT_LEADERBOARD');

		$start_date=intval(get_option('leaderboard_start_date'));

		$start=get_param_integer('lb_start',0);
		$max=get_param_integer('lb_max',52);

		// Ensure the leaderboard is getting calculated...
		$cutoff=time()-60*60*24*7;
		$test=$GLOBALS['SITE_DB']->query_value_if_there('SELECT COUNT(*) FROM '.get_table_prefix().'leader_board WHERE date_and_time>'.strval($cutoff));
		if ($test==0) do_block('main_leader_board',array());

		// Continue on to displaying the leaderboard...

		$weeks=$GLOBALS['SITE_DB']->query('SELECT DISTINCT date_and_time FROM '.$GLOBALS['SITE_DB']->get_table_prefix().'leader_board WHERE date_and_time>='.strval($start_date).' ORDER BY date_and_time DESC',$max,$start);
		if (count($weeks)==0) warn_exit(do_lang_tempcode('NO_ENTRIES'));

		$num_weeks=$GLOBALS['SITE_DB']->query_value_if_there('SELECT COUNT(DISTINCT date_and_time) FROM '.$GLOBALS['SITE_DB']->get_table_prefix().'leader_board WHERE date_and_time>='.strval($start_date));

		$first_week=$weeks[count($weeks)-1]['date_and_time'];
		$weeks=collapse_1d_complexity('date_and_time',$weeks);
		$out=new ocp_tempcode();
		foreach ($weeks as $week)
		{
			$rows=collapse_2d_complexity('lb_member','lb_points',$GLOBALS['SITE_DB']->query_select('leader_board',array('lb_member','lb_points'),array('date_and_time'=>$week)));
			$week_tpl=new ocp_tempcode();
			foreach ($rows as $member=>$points)
			{
				$points_url=build_url(array('page'=>'points','type'=>'member','id'=>$member),get_module_zone('points'));
				$profile_url=$GLOBALS['FORUM_DRIVER']->member_profile_url($member,false,true);
				$username=$GLOBALS['FORUM_DRIVER']->get_username($member);
				if (is_null($username)) $username=do_lang('UNKNOWN');
				$week_tpl->attach(do_template('POINTS_LEADERBOARD_ROW',array('_GUID'=>'6d323b4b5abea0e82a14cb4745c4af4f','POINTS_URL'=>$points_url,'PROFILE_URL'=>$profile_url,'POINTS'=>integer_format($points),'USERNAME'=>$username,'ID'=>strval($member))));
			}
			$nice_week=intval(($week-$first_week)/(7*24*60*60)+1);
			$out->attach(do_template('POINTS_LEADERBOARD_WEEK',array('_GUID'=>'3a0f71bf20f9098e5711e85cf25f6549','WEEK'=>integer_format($nice_week),'ROWS'=>$week_tpl)));
		}

		require_code('templates_pagination');
		$pagination=pagination(do_lang_tempcode('POINT_LEADERBOARD'),$start,'lb_start',$max,'lb_max',$num_weeks);

		$tpl=do_template('POINTS_LEADERBOARD_SCREEN',array('_GUID'=>'bab5f7b661435b83800532d3eebd0d54','TITLE'=>$title,'WEEKS'=>$out,'PAGINATION'=>$pagination));

		require_code('templates_internalise_screen');
		return internalise_own_screen($tpl);
	}

}


