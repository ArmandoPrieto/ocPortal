<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2011

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		core_ocf
 */

/**
 * Module page class.
 */
class Module_join
{

	/**
	 * Standard modular info function.
	 *
	 * @return ?array	Map of module info (NULL: module is disabled).
	 */
	function info()
	{
		$info=array();
		$info['author']='Chris Graham';
		$info['organisation']='ocProducts';
		$info['hacked_by']=NULL;
		$info['hack_version']=NULL;
		$info['version']=2;
		$info['locked']=false;
		return $info;
	}
	
	/**
	 * Standard modular entry-point finder function.
	 *
	 * @return ?array	A map of entry points (type-code=>language-code) (NULL: disabled).
	 */
	function get_entry_points()
	{
		return array('misc'=>'_JOIN');
	}

	/**
	 * Standard modular run function.
	 *
	 * @return tempcode	The result of execution.
	 */
	function run()
	{
		/*if (get_option('allow_member_integration')=='strict')
		{
			$title=get_page_title('_JOIN');
			$url='http://ocproducts.com/index.php?page=join';
			require_code('site2');
			assign_refresh($url,1.0);
			return do_template('REDIRECT_SCREEN',array('_GUID'=>'8398057d3427d54c105fb9c9ae9d2940','URL'=>$url,'TITLE'=>$title,'NO_COMPLETE'=>true,'TEXT'=>do_lang_tempcode('INT_STRICT',ocp_srv('HTTP_HOST'))));
		}*/

		if (get_forum_type()!='ocf') warn_exit(do_lang_tempcode('NO_OCF')); else ocf_require_all_forum_stuff();
		require_css('ocf');
		require_code('ocf_members_action');
		require_code('ocf_members_action2');
	
		global $LDAP_CONNECTION;
		if ((!is_null($LDAP_CONNECTION)) && (get_option('ldap_allow_joining',true)==='0'))
			warn_exit(do_lang_tempcode('JOIN_DISALLOW'));

		$type=get_param('type','misc');
	
		if ($type=='misc') return (get_option('show_first_join_page')!='1')?$this->step2():$this->step1();
		if ($type=='step2') return $this->step2();
		if ($type=='step3') return $this->step3();
		if ($type=='step4') return $this->step4();
	
		return new ocp_tempcode();
	}
	
	/**
	 * The UI to accept the rules of joining.
	 *
	 * @return tempcode		The UI
	 */
	function step1()
	{
		if (!is_guest()) warn_exit(do_lang_tempcode('NO_JOIN_LOGGED_IN'));
	
		$title=get_page_title('_JOIN');

		// Show rules
		$rules=request_page('rules',true,get_comcode_zone('rules'),NULL,true);
		$map=array('page'=>'_SELF','type'=>'step2');
		$email_address=trim(get_param('email_address',''));
		if ($email_address!='') $map['email_address']=$email_address;
		$redirect=get_param('redirect','');
		if ($redirect!='') $map['redirect']=$redirect;
		$url=build_url($map,'_SELF');

		$group_select=new ocp_tempcode();
		$rows=$GLOBALS['FORUM_DB']->query_select('f_groups',array('id','g_name','g_is_default'),array('g_is_presented_at_install'=>1));
		if (count($rows)>1)
		{
			foreach ($rows as $group)
			{
				if (get_param_integer('usergroup',-1)==-1)
				{
					$selected=$group['g_is_default']==1;
				} else
				{
					$selected=$group['id']==get_param_integer('usergroup');
				}
				$group_select->attach(form_input_list_entry(strval($group['id']),$selected,get_translated_text($group['g_name'])));
			}
		}

		breadcrumb_set_self(do_lang_tempcode('_JOIN'));

		$generate_host='';
		//if ((get_option('allow_member_integration')!='off') && (get_option('allow_member_integration')!='hidden')) $generate_host=ocp_srv('HTTP_HOST');

		return do_template('OCF_JOIN_STEP1_SCREEN',array('_GUID'=>'3776e89f3b18e4bd9dd532defe6b1e9e','TITLE'=>$title,'GENERATE_HOST'=>$generate_host,'RULES'=>$rules,'URL'=>$url,'GROUP_SELECT'=>$group_select));
	}

	/**
	 * The UI to enter profile details.
	 *
	 * @return tempcode		The UI
	 */
	function step2()
	{
		if (!is_guest()) warn_exit(do_lang_tempcode('NO_JOIN_LOGGED_IN'));

		$title=get_page_title('_JOIN');

		if ((get_option('show_first_join_page')=='1') && (post_param_integer('confirm',0)!=1))
			warn_exit(do_lang_tempcode('DESCRIPTION_I_AGREE_RULES'));

		$hidden=new ocp_tempcode();

		$groups=ocf_get_all_default_groups(true);
		$additional_group=either_param_integer('additional_group',-1);
		if (($additional_group!=-1) && (!in_array($additional_group,$groups)))
		{
			// Check security
			$test=$GLOBALS['FORUM_DB']->query_value('f_groups','g_is_presented_at_install',array('id'=>$additional_group));
			if ($test==1)
			{
				$groups=ocf_get_all_default_groups(false);
				$hidden=form_input_hidden('additional_group',strval($additional_group));
				$groups[]=$additional_group;
			}
		}

		list($fields,$_hidden)=ocf_get_member_fields(true,NULL,$groups);
		$hidden->attach($_hidden);

		$forum_id=get_option('intro_forum_id');
		if ($forum_id!='')
		{
			$fields->attach(do_template('FORM_SCREEN_FIELD_SPACER',array('TITLE'=>do_lang_tempcode('INTRODUCE_YOURSELF'))));
			$fields->attach(form_input_line(do_lang_tempcode('TITLE'),'','intro_title',do_lang('INTRO_POST_DEFAULT','___'),false));
			$fields->attach(form_input_text_comcode(do_lang_tempcode('POST_COMMENT'),do_lang_tempcode('DESCRIPTION_INTRO_POST'),'intro_post','',false));
		}

		$text=do_lang_tempcode('ENTER_PROFILE_DETAILS');

		if (addon_installed('captcha'))
		{
			require_code('captcha');
			if (use_captcha())
			{
				$fields->attach(form_input_captcha());
				$text->attach(' ');
				$text->attach(do_lang_tempcode('FORM_TIME_SECURITY'));
			}
		}

		$submit_name=do_lang_tempcode('PROCEED');
		$map=array('page'=>'_SELF','type'=>'step3');
		$redirect=get_param('redirect','');
		if ($redirect!='') $map['redirect']=$redirect;
		$url=build_url($map,'_SELF');

		breadcrumb_set_parents(array(array('_SELF:_SELF:misc',do_lang_tempcode('_JOIN'))));
		breadcrumb_set_self(do_lang_tempcode('DETAILS'));

		require_javascript('javascript_ajax');

		$script=find_script('username_check');
		$javascript="
			var form=document.getElementById('username').form;
			form.elements['username'].onchange=function()
			{
				if (form.elements['intro_title'])
					form.elements['intro_title'].value='".addslashes(do_lang('INTRO_POST_DEFAULT'))."'.replace(/\{1\}/g,form.elements['username'].value);
			}
			form.old_submit=form.onsubmit;
			form.onsubmit=function()
				{
					if ((form.elements['email_address_confirm']) && (form.elements['email_address_confirm'].value!=form.elements['email_address'].value))
					{
						window.alert('".php_addslashes(do_lang('EMAIL_ADDRESS_MISMATCH'))."');
						return false;
					}
					if ((form.elements['password_confirm']) && (form.elements['password_confirm'].value!=form.elements['password'].value))
					{
						window.alert('".php_addslashes(do_lang('PASSWORD_MISMATCH'))."');
						return false;
					}
					document.getElementById('submit_button').disabled=true;
					var url='".addslashes($script)."?username='+window.encodeURIComponent(form.elements['username'].value);
					if (!do_ajax_field_test(url,'password='+window.encodeURIComponent(form.elements['password'].value)))
					{
						document.getElementById('submit_button').disabled=false;
						return false;
					}
		";
		$script=find_script('snippet');
		if (get_option('is_on_invites')=='1')
		{
			$javascript.="
					url='".addslashes($script)."?snippet=invite_missing&name='+window.encodeURIComponent(form.elements['email_address'].value);
					if (!do_ajax_field_test(url))
					{
						document.getElementById('submit_button').disabled=false;
						return false;
					}
			";
		}
		if (get_option('one_per_email_address')=='1')
		{
			$javascript.="
					url='".addslashes($script)."?snippet=email_exists&name='+window.encodeURIComponent(form.elements['email_address'].value);
					if (!do_ajax_field_test(url))
					{
						document.getElementById('submit_button').disabled=false;
						return false;
					}
			";
		}
		if ((addon_installed('captcha')) && (get_option('use_security_images')=='1'))
		{
			$javascript.="
					url='".addslashes($script)."?snippet=captcha_wrong&name='+window.encodeURIComponent(form.elements['security_image'].value);
					if (!do_ajax_field_test(url))
					{
						document.getElementById('submit_button').disabled=false;
						return false;
					}
			";
		}
		$javascript.="
					document.getElementById('submit_button').disabled=false;
					if (typeof form.old_submit!='undefined' && form.old_submit) return form.old_submit();
					return true;
				};
		";

		$form=do_template('FORM',array('TEXT'=>'','HIDDEN'=>$hidden,'FIELDS'=>$fields,'SUBMIT_NAME'=>$submit_name,'URL'=>$url));

		return do_template('OCF_JOIN_STEP2_SCREEN',array('_GUID'=>'5879db5cf331526a999371f76868233d','JAVASCRIPT'=>$javascript,'TITLE'=>$title,'FORM'=>$form));
	}

	/**
	 * The actualiser for adding a member.
	 *
	 * @return tempcode		The UI
	 */
	function step3()
	{
		$title=get_page_title('_JOIN');

		// Read in data
		$username=trim(post_param('username'));
		$password=trim(post_param('password'));
		$password_confirm=trim(post_param('password_confirm'));
		if ($password!=$password_confirm) warn_exit(make_string_tempcode(escape_html(do_lang('PASSWORD_MISMATCH'))));
		$confirm_email_address=post_param('email_address_confirm',NULL);
		$email_address=trim(post_param('email_address'));
		if (!is_null($confirm_email_address))
		{
			if (trim($confirm_email_address)!=$email_address) warn_exit(make_string_tempcode(escape_html(do_lang('EMAIL_ADDRESS_MISMATCH'))));
		}
		require_code('type_validation');
		if (!is_valid_email_address($email_address)) warn_exit(do_lang_tempcode('INVALID_EMAIL_ADDRESS'));
		if (get_option('is_on_invites')=='1')
		{
			$test=$GLOBALS['FORUM_DB']->query_value_null_ok('f_invites','i_inviter',array('i_email_address'=>$email_address,'i_taken'=>0));
			if (is_null($test)) warn_exit(do_lang_tempcode('NO_INVITE'));
		}
		$dob_day=post_param_integer('dob_day',NULL);
		$dob_month=post_param_integer('dob_month',NULL);
		$dob_year=post_param_integer('dob_year',NULL);
		$reveal_age=post_param_integer('reveal_age',0);
		$timezone=post_param('timezone',get_users_timezone());
		$language=post_param('language',get_site_default_lang());
		$allow_emails=post_param_integer('allow_emails',0);
		$groups=ocf_get_all_default_groups(true);
		$additional_group=post_param_integer('additional_group',-1);
		if (($additional_group!=-1) && (!in_array($additional_group,$groups)))
		{
			// Check security
			$test=$GLOBALS['FORUM_DB']->query_value('f_groups','g_is_presented_at_install',array('id'=>$additional_group));
			if ($test==1)
			{
				$groups=ocf_get_all_default_groups(false);
				$groups[]=$additional_group;
			} else $additional_group=-1;
		} else $additional_group=-1;
		if ($additional_group==-1)
		{
			$test=$GLOBALS['FORUM_DB']->query_value_null_ok('f_groups','id',array('g_is_presented_at_install'=>1));
			if (!is_null($test)) $additional_group=$test;
		}
		if (get_value('sep_cpf_join_setting')==='1')
		{
			$custom_fields=ocf_get_all_custom_fields_match($groups,NULL,NULL,NULL,NULL,NULL,NULL,0,true);
		} else
		{
			$custom_fields=ocf_get_all_custom_fields_match($groups,NULL,NULL,NULL,1);
		}
		$actual_custom_fields=ocf_read_in_custom_fields($custom_fields);

		// Check that the given address isn't already used (if one_per_email_address on)
		$member_id=NULL;
		if (get_option('one_per_email_address')=='1')
		{
			$test=$GLOBALS['FORUM_DB']->query_select('f_members',array('id','m_username'),array('m_email_address'=>$email_address),'',1);
			if (array_key_exists(0,$test))
			{
				if ($test[0]['m_username']!=$username)
				{
					$reset_url=build_url(array('page'=>'lostpassword','email_address'=>$email_address),get_module_zone('lostpassword'));
					warn_exit(do_lang_tempcode('EMAIL_ADDRESS_IN_USE',escape_html(get_site_name()),escape_html($reset_url->evaluate())));
				}
				$member_id=$test[0]['id'];
			}
		}

		if (addon_installed('captcha'))
		{
			require_code('captcha');
			enforce_captcha();
		}

		if (addon_installed('ldap'))
		{
			require_code('ocf_ldap');
			if (ocf_is_ldap_member_potential($username))
				warn_exit(do_lang_tempcode('DUPLICATE_JOIN_AUTH'));
		}

		// Add member
		$skip_confirm=(get_option('skip_email_confirm_join')=='1');
		$validated_email_confirm_code=$skip_confirm?'':strval(mt_rand(1,32000));
		$require_new_member_validation=get_option('require_new_member_validation')=='1';
		$coppa=(get_option('is_on_coppa')=='1') && (servertime_to_usertime(time()-mktime(0,0,0,$dob_month,$dob_day,$dob_year))/31536000.0<13.0);
		$validated=($require_new_member_validation || $coppa)?0:1;
		if (is_null($member_id)) $member_id=ocf_make_member($username,$password,$email_address,$groups,$dob_day,$dob_month,$dob_year,$actual_custom_fields,$timezone,($additional_group!=-1)?$additional_group:NULL,$validated,time(),time(),'',NULL,'',0,(get_option('default_preview_guests')=='1')?1:0,$reveal_age,'','','',1,1,$language,$allow_emails,'',get_ip_address(),$validated_email_confirm_code,true,'','');
		/*if ($additional_group!=-1)
		{
			require_code('ocf_groups_action');
			require_code('ocf_groups_action2');
			ocf_add_member_to_group($member_id,$additional_group,1);
		}*/

		// Send confirm mail
		if (!$skip_confirm)
		{
			$zone=get_module_zone('join');
			if ($zone!='') $zone.='/';
			$_url=build_url(array('page'=>'join','type'=>'step4','email'=>$email_address,'code'=>$validated_email_confirm_code),$zone,NULL,false,false,true);
			$url=$_url->evaluate();
			$_url_simple=build_url(array('page'=>'join','type'=>'step4'),$zone,NULL,false,false,true);
			$url_simple=$_url_simple->evaluate();
			$redirect=get_param('redirect','');
			if ($redirect!='') $url.='&redirect='.ocp_url_encode($redirect);
			$message=do_lang('OCF_SIGNUP_TEXT',comcode_escape(get_site_name()),comcode_escape($url),array($url_simple,$email_address,strval($validated_email_confirm_code)),$language);
			require_code('mail');
			if (!$coppa) mail_wrap(do_lang('CONFIRM_EMAIL_SUBJECT',get_site_name(),NULL,NULL,$language),$message,array($email_address),$username);
		}

		// Send COPPA mail
		if ($coppa)
		{
			$fields_done=do_lang('THIS_WITH_COMCODE',do_lang('USERNAME'),$username)."\n\n";
			foreach ($custom_fields as $custom_field)
			{
				if ($custom_field['cf_type']!='upload')
				{
					$fields_done.=do_lang('THIS_WITH_COMCODE',$custom_field['trans_name'],post_param('custom_'.$custom_field['id'].'_value'))."\n";
				}
			}
			$_privacy_url=build_url(array('page'=>'privacy'),'_SEARCH',NULL,false,false,true);
			$privacy_url=$_privacy_url->evaluate();
			$message=do_lang('COPPA_MAIL',comcode_escape(get_option('site_name')),comcode_escape(get_option('privacy_fax')),array(comcode_escape(get_option('privacy_postal_address')),comcode_escape($fields_done),comcode_escape($privacy_url)),$language);
			mail_wrap(do_lang('COPPA_JOIN_SUBJECT',$username,get_site_name(),NULL,$language),$message,array($email_address),$username);
		}
		
		// Send 'validate this member' mail
		if ($require_new_member_validation)
		{
			require_code('mail');
			$_validation_url=build_url(array('page'=>'editprofile','id'=>$member_id),get_module_zone('editprofile'),NULL,false,false,true);
			$validation_url=$_validation_url->evaluate();
			$message=do_lang('VALIDATE_NEW_MEMBER_MAIL',comcode_escape($username),comcode_escape($validation_url),comcode_escape(strval($member_id)),get_site_default_lang());
			mail_wrap(do_lang('VALIDATE_NEW_MEMBER_SUBJECT',$username,NULL,NULL,get_site_default_lang()),$message,is_null(get_value('member_validator'))?NULL:array(get_value('member_validator')));
		}

		$GLOBALS['FORUM_DB']->query_update('f_invites',array('i_taken'=>1),array('i_email_address'=>$email_address,'i_taken'=>0),'',1);

		// Intro post
		$forum_id=get_option('intro_forum_id');
		if ($forum_id!='')
		{
			if (!is_numeric($forum_id)) $forum_id=strval($GLOBALS['FORUM_DB']->query_value('f_forums','id',array('f_name'=>$forum_id)));

			$intro_title=post_param('intro_title','');
			$intro_post=post_param('intro_post','');
			if ($intro_post!='')
			{
				require_code('ocf_topics_action');
				if ($intro_title=='') $intro_title=do_lang('INTRO_POST_DEFAULT',$username);
				$topic_id=ocf_make_topic(intval($forum_id));
				require_code('ocf_posts_action');
				ocf_make_post($topic_id,$intro_title,$intro_post,0,true,NULL,0,NULL,NULL,NULL,$member_id);
			}
		}

		// Alert user to situation
		$message=new ocp_tempcode();
		if ($coppa)
		{
			if (!$skip_confirm) $message->attach(do_lang_tempcode('OCF_WAITING_CONFIRM_MAIL'));
			$message->attach(do_lang_tempcode('OCF_WAITING_CONFIRM_MAIL_COPPA'));
		}
		elseif ($require_new_member_validation)
		{
			if (!$skip_confirm) $message->attach(do_lang_tempcode('OCF_WAITING_CONFIRM_MAIL'));
			$message->attach(do_lang_tempcode('OCF_WAITING_CONFIRM_MAIL_VALIDATED',escape_html(get_custom_base_url())));
		}
		elseif ($skip_confirm)
		{
			$_login_url=build_url(array('page'=>'login','redirect'=>get_param('redirect',NULL)),get_module_zone('login'));
			$login_url=$_login_url->evaluate();
			$message->attach(do_lang_tempcode('OCF_LOGIN_INSTANT',escape_html($login_url)));
		} else
		{
			if (!$skip_confirm) $message->attach(do_lang_tempcode('OCF_WAITING_CONFIRM_MAIL'));
			$message->attach(do_lang_tempcode('OCF_WAITING_CONFIRM_MAIL_INSTANT'));
		}
		$message=protect_from_escaping($message);

		breadcrumb_set_self(do_lang_tempcode('DONE'));

		breadcrumb_set_parents(array(array('_SELF:_SELF:misc',do_lang_tempcode('_JOIN'))));

		return inform_screen($title,$message);
	}

	/**
	 * The actualiser for setting up account confirmation.
	 *
	 * @return tempcode		The UI
	 */
	function step4()
	{
		$title=get_page_title('_JOIN');

		breadcrumb_set_parents(array(array('_SELF:_SELF:misc',do_lang_tempcode('_JOIN'))));
		breadcrumb_set_self(do_lang_tempcode('DONE'));

		// Check confirm code correct
		$_code=get_param('code',-1); // -1 allowed because people often seem to mess the e-mail link up
		$code=intval($_code);
		if ($code<=0)
		{
			require_code('form_templates');
			$fields=new ocp_tempcode();
			$fields->attach(form_input_email(do_lang_tempcode('EMAIL_ADDRESS'),'','email','',true));
			$fields->attach(form_input_integer(do_lang_tempcode('CODE'),'','code',NULL,true));
			$submit_name=do_lang_tempcode('PROCEED');
			return do_template('FORM_SCREEN',array('_GUID'=>'e2c8c3762a308ac7489ec3fb32cc0cf8','TITLE'=>$title,'GET'=>true,'SKIP_VALIDATION'=>true,'HIDDEN'=>'','URL'=>get_self_url(false,false,NULL,false,true),'FIELDS'=>$fields,'TEXT'=>do_lang_tempcode('MISSING_CONFIRM_CODE'),'SUBMIT_NAME'=>$submit_name));
		}
		$rows=$GLOBALS['FORUM_DB']->query_select('f_members',array('id','m_validated'),array('m_validated_email_confirm_code'=>strval($code),'m_email_address'=>trim(get_param('email'))));
		if (!array_key_exists(0,$rows))
		{
			$rows=$GLOBALS['FORUM_DB']->query_select('f_members',array('id','m_validated'),array('m_validated_email_confirm_code'=>'','m_email_address'=>trim(get_param('email'))));
			if (!array_key_exists(0,$rows))
			{
				warn_exit(do_lang_tempcode('INCORRECT_CONFIRM_CODE'));
			} else
			{
				$redirect=get_param('redirect','');
				$map=array('page'=>'login','type'=>'misc');
				if ($redirect!='') $map['redirect']=$redirect;
				$url=build_url($map,get_module_zone('login'));
				return redirect_screen($title,$url,do_lang_tempcode('ALREADY_CONFIRMED_THIS'));
			}
		}
		$id=$rows[0]['id'];
		$validated=$rows[0]['m_validated'];

		// Activate user
		$GLOBALS['FORUM_DB']->query_update('f_members',array('m_validated_email_confirm_code'=>''),array('id'=>$id),'',1);

		if ($validated==0)
		{
			return inform_screen($title,do_lang_tempcode('AWAITING_MEMBER_VALIDATION'));
		}

		// Alert user to situation
		$redirect=get_param('redirect','');
		$map=array('page'=>'login','type'=>'misc');
		if ($redirect!='') $map['redirect']=$redirect;
		$url=build_url($map,get_module_zone('login'));
		return redirect_screen($title,$url,do_lang_tempcode('SUCCESSFUL_CONFIRM'));
	}

}


