<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2011

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		news
 */

/**
 * Update news to twitter.
 *
 * @param  AUTO_LINK		The ID of the news 
 * @param  SHORT_TEXT	Message
 * @param  BINARY			Whether the news has been validated
 * @param  AUTO_LINK		Main news category's id	
 * @param  boolean		Current process indication. If it is update, need to check it's old "validated" state
 * @return boolean		Returns the success status of function
 */
function twitter_news_update($id,$message,$validated,$main_news_category_id,$update=true)
{
	if (!($validated==1) || !(has_category_access($GLOBALS['FORUM_DRIVER']->get_guest_id(),'news',strval($main_news_category_id))))
	{
		return false;
	}
	
	if($update)
	{
		$validated_old=$GLOBALS['SITE_DB']->query_value('news','validated',array('id'=>$id));

		if($validated_old==1) return false; // skip twitter add if the news was already validated.
	}

	// Username and password
	$username=get_option('twitter_login');
	$password=get_option('twitter_password');


	// Checking twitter requirements
	
	if(is_null($username)) return false;
	if($username=='') return false;

	if(strlen($message)>249)
	{
		$_more_url=build_url(array('page'=>'news','type'=>'view','id'=>$id),get_module_zone('news'),NULL,false,false,true);
		$more_url=$_more_url->evaluate();
		$url_length=strlen($more_url);
		$message=substr($message,0,245-$url_length);
		$message.= "...".urlencode($more_url);
	}

	require_code('twitter');

	$twitter = new Twitter($username /* Consumer key */,$password /* Consumer secret */); // Create at http://dev.twitter.com/apps/new
	
	require_code('developer_tools');
	destrictify();

	// Not stored in DB?
	if (is_null(get_value('twitter_token')))
	{
		// get a request token
		$keep=symbol_tempcode('KEEP',array('1'));
		$twitter->oAuthRequestToken(find_script('twitter_oauth').$keep->evaluate());

		$twitter->oAuthAuthorize();

		return false;
	}

	// set tokens
	$twitter->setOAuthToken(get_value('twitter_token'));
	$twitter->setOAuthTokenSecret(get_value('twitter_token_secret'));

	// send message
	$twitter->statusesUpdate($message);

	return true;
}
