<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2012

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		static_export
 */

/**
 * Callback for saving a page-link into static output.
 *
 * @param  string		The page-link.
 * @param  string		The parent page-link in the ocPortal site tree.
 * @param  ?TIME		When the node was added (NULL: unknown).
 * @param  ?TIME 		When the node was last edited (NULL: unknown/never).
 * @param  float		The priority of this for spidering, 0.0-1.0.
 * @param  string		The title of the node.
 * @param  boolean	Whether the category is accessible by the user the sitemap is being generated for (Guest for a Sitemaps XML file).
 */
function _pagelink_to_static($pagelink,$parent_pagelink,$add_date,$edit_date,$priority,$title,$accessible=true)
{
	if (($accessible) && (strpos($page_link,':static_export')===false))
	{
		global $STATIC_EXPORT_TAR;

		$date=time();
		if (!is_null($add_date)) $date=$add_date;
		if (!is_null($edit_date)) $date=$edit_date;

		$langs=find_all_langs();
		foreach (array_keys($langs) as $lang)
		{
			if (($lang!=fallback_lang()) && (count(get_directory_contents(get_custom_file_base().'/lang_custom/'.$lang)<5))) continue; // Probably this is just the utf8 addon

			$url_test=static_evaluate_tempcode(symbol_tempcode('PAGE_LINK',array($pagelink,'0','1')));
			if (strpos($url_test,'?')!==false) continue;

			$extended_pagelink=$pagelink;
			if ($pagelink=='') $extended_pagelink=':'.get_zone_default_page('');
			$extended_pagelink.=':keep_lang='.$lang;
			$url=static_evaluate_tempcode(symbol_tempcode('PAGE_LINK',array($extended_pagelink,'0','1')));

			$target_path=urldecode(preg_replace('#\?.*$#','',preg_replace('#^'.preg_quote(get_base_url(),'#').'/#','',$url)));

			$save_target_path=(count($langs)==1)?$target_path:($lang.'/'.$target_path);

			$directory=$STATIC_EXPORT_TAR['directory'];
			foreach ($directory as $entry) // Make sure it does not exist, due to some kind of dynamic parameter being folded out
			{
				if ($entry['path']==$save_target_path)
				{
					continue;
				}
			}

			$data=http_download_file($url,NULL,false);
			if (is_null($data)) continue;

			// Change absolute paths to relative ones
			$path_bits=explode('/',$target_path);
			array_pop($path_bits);
			$relative_root='';
			foreach ($path_bits as $path_bit)
			{
				$relative_root.='../';
			}
			$data=str_replace(get_base_url().'/',$relative_root,$data);
			$data=preg_replace('#<base\s[^>]*href="[^"]*"[^>]*>#','',$data);

			// Remove any references to other ocPortal PHP scripts (e.g. RSS script) or callbacks with dynamic parameters
			$data=preg_replace('#<meta\s[^>]*content="[^"]*\.php[^"]*"[^>]*>\s*#','',$data);
			$data=preg_replace('#<link\s[^>]*href="[^"]*\.php[^"]*"[^>]*>\s*#','',$data);
			$data=preg_replace('#<li><a href="[^"]*keep_mobile=1">.*</a></li>#U','',$data);
			$data=preg_replace('#<noscript><a href="[^"]*keep_has_js=0">.*</a></noscript>#U','',$data);
			$data=preg_replace('#<li><a href="[^"]*login.htm[^"]*">.*</a></li>#U','',$data);
			$data=preg_replace('#\?redirect=[^&"]*&#','?',$data);
			$data=preg_replace('#\?redirect=[^&"]*#','',$data);
			$data=preg_replace('#&redirect=[^&"]*#','',$data);

			tar_add_file($STATIC_EXPORT_TAR,$save_target_path,$data,0644,$date,false);
		}
	}
}
