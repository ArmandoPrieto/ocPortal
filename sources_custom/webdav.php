<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2013

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license		http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright	ocProducts Ltd
 * @package		webdav
 */

use Sabre\DAV;

/**
 * Main WebDAV entry-point script
 */
function webdav_script()
{
	require_code('sabredav/vendor/autoload');

	require_code('webdav_occlefs');

	$root_dir=new webdav_occlefs\Directory('');
	$server=new DAV\Server($root_dir);

	$parsed=parse_url(get_base_url());
	if (substr($parsed['path'],-1)!='/') $parsed['path'].='/';
	$webdav_root=get_value('webdav_root');
	if (is_null($webdav_root)) $webdav_root='webdav';
	$server->setBaseUri($parsed['path'].$webdav_root);

	$auth_backend=new webdav_occlefs\Auth();
	$auth_plugin=new DAV\Auth\Plugin($auth_backend,get_site_name()/*the auth realm*/);
	$server->addPlugin($auth_plugin);

	$lock_backend=new DAV\Locks\Backend\File(get_custom_file_base().'/data_custom/modules/webdav/locks/locks.dat');
	$lock_plugin=new DAV\Locks\Plugin($lock_backend);
	$server->addPlugin($lock_plugin);

	$tffp=new DAV\TemporaryFileFilterPlugin(get_custom_file_base().'/data_custom/modules/webdav/tmp');
	$server->addPlugin($tffp);

	$server->exec();
}
